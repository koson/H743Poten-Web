<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Poten2501.Pages.CVAnalysePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:cc="clr-namespace:Poten2501.CustomControls"
    xmlns:converters="clr-namespace:Poten2501.Converters"
    xmlns:scottplot="clr-namespace:ScottPlot.Maui;assembly=ScottPlot.Maui"
    xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
    xmlns:styles="clr-namespace:Poten2501.Styles"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewModels="clr-namespace:Poten2501.ViewModels"
    Title="CV Analyze">
    <ContentPage.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <styles:PageStyles />
            </ResourceDictionary.MergedDictionaries>
            <converters:CycleSelectedConverter x:Key="CycleSelectedConverter" />
            <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Style="{StaticResource GridStyles}">
        <Frame
            x:Name="FileOperationView"
            Grid.RowSpan="3"
            Style="{StaticResource ListViewStyle}"
            VerticalOptions="Start">
            <VerticalStackLayout Padding="10,0" Spacing="10">
                <Label
                    FontSize="Subtitle"
                    HorizontalOptions="Center"
                    Text="Project Management"
                    TextColor="#0055FF" />
                <Button Command="{Binding NewProjectCommand}" Text="New project" />
                <Button Command="{Binding OpenProjectCommand}" Text="Open project" />
                <Button
                    Command="{Binding SaveProjectCommand}"
                    IsEnabled="False"
                    IsVisible="True"
                    Text="Save project" />
                <Button
                    Command="{Binding SaveAsProjectCommand}"
                    IsEnabled="False"
                    IsVisible="True"
                    Text="Save as project" />
                <Button
                    Command="{Binding CloseProjectCommand}"
                    IsEnabled="False"
                    IsVisible="True"
                    Text="Close project" />
            </VerticalStackLayout>
        </Frame>
        <Frame
            Grid.Row="2"
            Grid.RowSpan="4"
            Style="{StaticResource CommConnectStyle}">
            <VerticalStackLayout Spacing="10">
                <Label
                    FontSize="Subtitle"
                    HorizontalOptions="Center"
                    Text="Process"
                    TextColor="#0055FF" />
                <Button Command="{Binding LoadCSVCommand}" Text="Import CSV file" />
                <Button Command="{Binding LoadEmStatDataCommand}" Text="Load EMStat file" />
                <Button Command="{Binding LoadExcelCommand}" Text="Load Excel file" />
                <Button Command="{Binding CompareChartCommand}" Text="Compare charts" />
                <Button Command="{Binding ComparePeaksCommand}" Text="Compare peaks" />
                <Label Text="{Binding FileName}" />

            </VerticalStackLayout>
        </Frame>

        <Frame
            Grid.Row="0"
            Grid.RowSpan="1"
            MaximumHeightRequest="100"
            Style="{StaticResource MeasureParamsStyle}">
            <VerticalStackLayout MinimumHeightRequest="50">
                <ListView IsVisible="False" ItemsSource="{Binding FilteredData}">
                    <ListView.Header>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Label
                                Grid.Column="0"
                                FontAttributes="Bold"
                                Text="Counter" />
                            <Label
                                Grid.Column="1"
                                FontAttributes="Bold"
                                Text="REVoltage" />
                            <Label
                                Grid.Column="2"
                                FontAttributes="Bold"
                                Text="WEVoltage" />
                        </Grid>
                    </ListView.Header>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <ViewCell>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Label Grid.Column="0" Text="{Binding [Counter]}" />
                                    <Label Grid.Column="1" Text="{Binding [REVoltage]}" />
                                    <Label Grid.Column="2" Text="{Binding [WEVoltage]}" />
                                </Grid>
                            </ViewCell>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </VerticalStackLayout>
        </Frame>
        <Frame Style="{StaticResource ScottplotStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="80*" />
                    <ColumnDefinition Width="20*" />
                </Grid.ColumnDefinitions>
                <VerticalStackLayout Grid.Column="0" Margin="5">
                    <Label
                        FontAttributes="Bold"
                        Text="Cycle Nos:"
                        TextColor="#0055FF" />
                    <CollectionView ItemsSource="{Binding CycleNos}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <HorizontalStackLayout>
                                    <RadioButton 
                                        GroupName="CycleNosGroup" 
                                        Content="{Binding .}" 
                                        IsChecked="{Binding ., Converter={StaticResource CycleSelectedConverter}, ConverterParameter={Binding .}}">
                                        <RadioButton.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:CVAnalyzeViewModel}}, Path=CheckboxChangedCommand}" 
                                                CommandParameter="{Binding .}" />
                                        </RadioButton.GestureRecognizers>
                                    </RadioButton>
                                    <Label Text="{Binding .}" VerticalTextAlignment="Center" />
                                </HorizontalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    <Button Text="Save Metadata" 
                            Command="{Binding SaveMetedataCommand}"/>
                </VerticalStackLayout>
                <cc:PlotView
                    x:Name="PlotView"
                    Grid.Column="1"
                    DataX="{Binding DataX}"
                    DataY="{Binding DataY}"
                    HorizontalOptions="FillAndExpand"
                    VerticalOptions="FillAndExpand" />
                <StackLayout
                    Grid.Column="2"
                    Margin="10"
                    Spacing="2">
                    <Button
                        Command="{Binding PeakDetectCommand}"
                        IsEnabled="True"
                        Text="Peak detect" />
                    <Button
                        Command="{Binding AddToProjectCommand}"
                        IsEnabled="True"
                        Text="Add to project" />
                    <Label
                        HorizontalOptions="Center"
                        Text="Anodic Peak Location"
                        TextColor="#0000aa" />
                    <Slider
                        x:Name="AnodicPeakLocationSlider"
                        Maximum="1200"
                        Minimum="-1200"
                        ValueChanged="OnAnodicPeakLocationChanged"
                        Value="{Binding AnodicPeakLocation}" />
                    <Label x:Name="AnodicPeakLabel"   HorizontalOptions="Center" />
                    <Label Text="Anodic Baseline Start" />
                    <Slider
                        x:Name="AnodicBaselineStartSlider"
                        Maximum="1200"
                        Minimum="-1200"
                        ValueChanged="OnAnodicBaselineStartChanged"
                        Value="{Binding AnodicBaselineStart}" />
                    <Label x:Name="AnodicBaselineStartLabel" HorizontalOptions="Center" />
                    
                    <Label Text="Anodic baseline End" />
                    <Slider
                        Maximum="1200"
                        Minimum="-1200"
                        ValueChanged="OnAnodicBaselineEndChanged"
                        Value="{Binding AnodicBaselineEnd}" />
                    <Label x:Name="AnodicBaselineEndLabel" HorizontalOptions="Center" />

                    <Label
                        FontSize="Subtitle"
                        Text="Cathodic Peak"
                        TextColor="#0000ff" />

                    <Label Text="Cathodic Peak Location" TextColor="#0000aa" />
                    <Slider
                        x:Name="CathodicPeakLocationSlider"
                        Maximum="1200"
                        Minimum="-1200"
                        ValueChanged="OnCathodicPeakLocationChanged"
                        Value="{Binding CathodicPeakLocation}" />
                    <Label x:Name="CathodicPeakLabel" HorizontalOptions="Center" />


                    <Label Text="Cathodic Baseline Start" />
                    <Slider
                        x:Name="CathodicBaselineStartSlider"
                        Maximum="1200"
                        Minimum="-1200"
                        ValueChanged="OnCathodicBaselineStartChanged"
                        Value="{Binding CathodicBaselineStart}" />
                    <Label x:Name="CathodicBaselineStartLabel" HorizontalOptions="Center" />

                    <Label Text="Cathodic baseline End" />
                    <Slider
                        Maximum="1200"
                        Minimum="-1200"
                        ValueChanged="OnCathodicBaselineEndChanged"
                        Value="{Binding CathodicBaselineEnd}" />
                    <Label x:Name="CathodicBaselineEndLabel" HorizontalOptions="Center" />

                    <Button Text="Save Metadata" 
                            Command="{Binding SaveMetedataCommand}"/>    

                </StackLayout>
            </Grid>
        </Frame>
        <Frame MinimumWidthRequest="225" Style="{StaticResource CVAnalyzeStyle}">
            <VerticalStackLayout Margin="5" Spacing="10">
                <Label
                    FontSize="Subtitle"
                    HorizontalOptions="Center"
                    Text="Graph lists"
                    TextColor="#0055FF" />
                <ListView ItemsSource="{Binding DataFiles}">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <TextCell
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:CVAnalyzeViewModel}}, Path=LoadDataFromGraphListCommand}"
                                CommandParameter="{Binding .}"
                                Text="{Binding .}"
                                TextColor="DarkBlue">
                                <TextCell.ContextActions>
                                    <MenuItem
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:CVAnalyzeViewModel}}, Path=RenameCommand}"
                                        CommandParameter="{Binding .}"
                                        IsDestructive="False"
                                        Text="Rename" />
                                    <MenuItem
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:CVAnalyzeViewModel}}, Path=DeleteCommand}"
                                        CommandParameter="{Binding .}"
                                        IsDestructive="True"
                                        Text="Delete" />
                                    <MenuItem
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:CVAnalyzeViewModel}}, Path=EditMetaDataCommand}"
                                        CommandParameter="{Binding .}"
                                        IsDestructive="False"
                                        Text="Add Concentration" />
                                </TextCell.ContextActions>
                            </TextCell>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </VerticalStackLayout>
        </Frame>
    </Grid>
</ContentPage>
