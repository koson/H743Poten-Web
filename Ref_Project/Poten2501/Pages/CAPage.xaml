<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Poten2501.Pages.CAPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:cc="clr-namespace:Poten2501.CustomControls"
    xmlns:controls="clr-namespace:Microsoft.Maui.Controls;assembly=Microsoft.Maui.Controls"
    xmlns:skia="clr-namespace:SkiaSharp;assembly=SkiaSharp"
    xmlns:sp="clr-namespace:ScottPlot.Maui;assembly=ScottPlot.Maui"
    xmlns:styles="clr-namespace:Poten2501.Styles"
    xmlns:viewModel="clr-namespace:Poten2501.ViewModels"
    xmlns:converters="clr-namespace:Poten2501.Converters"
    Title="Chronoamperometry"
    x:DataType="viewModel:CAViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <styles:PageStyles />
            </ResourceDictionary.MergedDictionaries>
            <converters:VoltageConverter x:Key="VoltageConverter" />
            <converters:CurrentConverter x:Key="CurrentConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid Style="{StaticResource GridStyles}">

            <Frame
                x:Name="FileOperationView"
                Grid.RowSpan="3"
                Style="{StaticResource ListViewStyle}">
                <VerticalStackLayout>
                    <Label
                        FontAttributes="Bold"
                        FontSize="Subtitle"
                        HorizontalTextAlignment="Center"
                        Text="Project Manager"
                        TextColor="#0055ff" />
                    <Label Text="Project Location" />

                    <HorizontalStackLayout>
                        <Entry
                            MaximumWidthRequest="180"
                            MinimumWidthRequest="180"
                            Text="{Binding WorkingFolderPath}" />
                        <Button
                            Margin="5"
                            Command="{Binding SelectProjectFolderCommand}"
                            Text="..." />
                    </HorizontalStackLayout>

                    <Label Padding="0,10,0,0" Text="Project Name" />
                    <Entry
                        Margin="0,5,0,0"
                        MaxLength="32"
                        Placeholder="Enter project name"
                        Text="{Binding ProjectName}" />
                    <Label Padding="0,10,0,0" Text="File Name" />
                    <Entry
                        Margin="0,5,0,0"
                        IsReadOnly="True"
                        MaxLength="80"
                        Placeholder="Generated file name"
                        Text="{Binding FileName}" />
                </VerticalStackLayout>
            </Frame>
            <Frame Style="{StaticResource MeasureParamsStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="1*" />
                        <ColumnDefinition Width="1*" />
                        <ColumnDefinition Width="1*" />
                        <ColumnDefinition Width="1*" />
                        <ColumnDefinition Width="1*" />
                        <ColumnDefinition Width="1*" />
                    </Grid.ColumnDefinitions>
                    <Label
                        Grid.Column="0"
                        FontSize="Medium"
                        HorizontalTextAlignment="Center"
                        Text="Potential : "
                        TextColor="#0055cc"
                        VerticalTextAlignment="Center" />
                    <Label
                        Grid.Column="1"
                        Grid.ColumnSpan="3"
                        FontAttributes="Bold"
                        FontSize="Large"
                        HorizontalTextAlignment="Start"
                        Text="{Binding CAPotential , Converter={StaticResource VoltageConverter}}"
                        TextColor="#008800" />
                    <Label
                        Grid.Column="3"
                        FontSize="Medium"
                        HorizontalTextAlignment="Center"
                        Text="Current :  "
                        TextColor="#0055cc"
                        VerticalTextAlignment="Center" />
                    <Label
                        Grid.Column="4"
                        Grid.ColumnSpan="3"
                        FontAttributes="Bold"
                        FontSize="Large"
                        HorizontalTextAlignment="Start"
                        Text="{Binding CACurrent , Converter={StaticResource CurrentConverter}}"
                        TextColor="#008800" />
                </Grid>
            </Frame>

            <Frame Style="{StaticResource ScottplotStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <cc:PlotView
                        x:Name="CAPlot"
                        Grid.Row="0"
                        Grid.Column="0"
                        DataX="{Binding DataX}"
                        DataY="{Binding DataY}" />

                    <VerticalStackLayout
                        Grid.Column="1"
                        Margin="5"
                        HorizontalOptions="Center">
                        <Button Margin="0,5"
                                Command="{Binding StartCAScanCommand}" 
                                Text="Start scan" />
                        <Button Margin="0,5" Text="Stop scan" />
                        <Button
                            Margin="0,5"
                            Command="{Binding ClearChartCommand}"
                            Text="Clear Chart"
                            WidthRequest="100" />
                        <Button Margin="0,5" Text="Export CSV" />
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <Frame IsVisible="Hidden" Style="{StaticResource TerminalStyle}">
                <VerticalStackLayout>
                    <Grid ColumnSpacing="3" RowSpacing="3">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="85*" />
                            <ColumnDefinition Width="15*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="10*" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <Label
                            FontAttributes="Bold"
                            FontSize="Subtitle"
                            Text="Messages" />
                        <Editor
                            Grid.Row="1"
                            Grid.Column="0"
                            Margin="5"
                            HeightRequest="180"
                            IsReadOnly="True"
                            Text="{Binding ReceivedData}" />
                        <Button
                            Grid.Row="1"
                            Grid.Column="1"
                            Margin="3"
                            Command="{Binding ClearReceivedDataCommand}"
                            HeightRequest="15"
                            Text="Clear Message"
                            VerticalOptions="Start"
                            WidthRequest="150" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <Frame Style="{StaticResource CAParametersStyle}">
                <ScrollView>
                    <VerticalStackLayout Spacing="10">
                        <Label
                            FontAttributes="Bold"
                            FontSize="Subtitle"
                            HorizontalOptions="Center"
                            Text="CA Parameters"
                            TextColor="#0055ff" />

                        <Grid ColumnSpacing="3" RowSpacing="3">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="40*" />
                                <ColumnDefinition Width="50*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Label
                                Grid.Row="0"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                FontSize="Subtitle"
                                HorizontalOptions="Start"
                                Text="Introduction Period"
                                TextColor="#a00" />
                            <Label
                                Grid.Row="1"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="Potential (V)"
                                VerticalTextAlignment="Center" />
                            <Entry Grid.Row="1" 
                                   Placeholder="0.0" 
                                   Text="{Binding InductionPotential}" 
                                   Grid.Column="1" />
                            <Label
                                Grid.Row="2"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="Duration (S)"
                                VerticalTextAlignment="Center" />
                            <Entry Grid.Row="2" 
                                   Placeholder="3.0" 
                                   Text="{Binding InductionDuration}" 
                                   Grid.Column="1" />
                            <Label
                                Grid.Row="3"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                FontSize="Subtitle"
                                HorizontalOptions="Start"
                                Text="Forward StepPeriod"
                                TextColor="#a00" />
                            <Label
                                Grid.Row="4"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="Potential (V)"
                                VerticalTextAlignment="Center" />
                            <Entry Grid.Row="4" 
                                   Placeholder="0.5" 
                                   Text="{Binding ElectrolysisPotential}" 
                                   Grid.Column="1" />
                            <Label
                                Grid.Row="5"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="Duration (S)"
                                VerticalTextAlignment="Center" />
                            <Entry Grid.Row="5" 
                                   Placeholder="10" 
                                   Text="{Binding ElectrolysisDuration}" 
                                   Grid.Column="1" />
                            <Label
                                Grid.Row="6"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                FontSize="Subtitle"
                                HorizontalOptions="Start"
                                Text="Relaxation Period"
                                TextColor="#a00" />
                            <Label
                                Grid.Row="7"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="Potential (V)"
                                VerticalTextAlignment="Center" />
                            <Entry Grid.Row="7" 
                                   Placeholder="0.0" 
                                   Text="{Binding RelaxationPotential}" 
                                   Grid.Column="1" />
                            <Label
                                Grid.Row="8"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="Duration (S)"
                                VerticalTextAlignment="Center" />
                            <Entry Grid.Row="8" 
                                   Placeholder="3.0" 
                                   Text="{Binding RelaxationDuration}" 
                                   Grid.Column="1" />
                            <Label
                                Grid.Row="9"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                FontSize="Subtitle"
                                HorizontalOptions="Start"
                                Text="Current Range"
                                TextColor="#a00" />
                            <Label
                                Grid.Row="10"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="Current range(A)"
                                VerticalTextAlignment="Center" />
                            <Picker
                                x:Name="entCurrentGain"
                                Grid.Row="10"
                                Grid.Column="1"
                                ItemsSource="{Binding PickerItems}"
                                SelectedIndex="0"
                                SelectedIndexChanged="entCurrentGain_SelectedIndexChanged"
                                SelectedItem="{Binding SelectedPickerItem}" />
                            <Label
                                Grid.Row="11"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                FontSize="Subtitle"
                                HorizontalOptions="Start"
                                Text="Misc."
                                TextColor="#a00" />
                            <Label
                                Grid.Row="12"
                                Grid.Column="0"
                                HorizontalOptions="Start"
                                Text="No. of cycles"
                                VerticalTextAlignment="Center" />
                            <Entry Grid.Row="12" 
                                   Placeholder="5" 
                                   Text="{Binding NoOfCycles}" 
                                   Grid.Column="1" />
                        </Grid>

                    </VerticalStackLayout>
                </ScrollView>
            </Frame>

            <Frame Style="{StaticResource CommConnectStyle}">
                <ScrollView>
                    <VerticalStackLayout>
                        <Label
                            Margin="0,0,0,10"
                            FontAttributes="Bold"
                            FontSize="Subtitle"
                            HorizontalOptions="Center"
                            Text="Serial port connection"
                            TextColor="#0055ff" />
                        <Button Command="{Binding ConnectCommand}" Text="{Binding ConnectButtonText}" />
                        <Grid Margin="0,10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Label
                                Grid.Row="0"
                                Grid.Column="0"
                                Text="Available Ports:"
                                VerticalTextAlignment="Center" />
                            <Picker
                                Grid.Row="0"
                                Grid.Column="1"
                                ItemsSource="{Binding AvailablePorts}"
                                SelectedItem="{Binding SelectedPort}" />
                            <Label
                                Grid.Row="1"
                                Grid.Column="0"
                                Text="Baud Rate:"
                                VerticalTextAlignment="Center" />
                            <Picker
                                Grid.Row="1"
                                Grid.Column="1"
                                ItemsSource="{Binding BaudRates}"
                                SelectedItem="{Binding SelectedBaudRate}" />
                        </Grid>
                        <Button Command="{Binding RefreshPortsCommand}" Text="Refresh Ports" />
                    </VerticalStackLayout>
                </ScrollView>
            </Frame>

        </Grid>
    </Grid>

</ContentPage>