<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Instrument Calibration Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        .calibration-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .calibration-card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .progress-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .correction-factor {
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.25rem 0;
            font-family: monospace;
        }
        .validation-test {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin: 0.5rem 0;
        }
        .validation-test.pass { border-left-color: #28a745; }
        .validation-test.fail { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-calibrate"></i> Cross-Instrument Calibration Dashboard</h1>
                    <p class="mb-0">H743 Potentiostat Calibration Management System</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-white-50">
                        <small>Last Updated: <span id="lastUpdated">Loading...</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card calibration-card">
                    <div class="card-body text-center">
                        <i class="fas fa-microchip fa-2x text-primary mb-2"></i>
                        <h5>Instruments</h5>
                        <h3 id="instrumentCount" class="text-primary">-</h3>
                        <small class="text-muted">Registered</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card calibration-card">
                    <div class="card-body text-center">
                        <i class="fas fa-adjust fa-2x text-success mb-2"></i>
                        <h5>Corrections</h5>
                        <h3 id="correctionCount" class="text-success">-</h3>
                        <small class="text-muted">Active Factors</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card calibration-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-warning mb-2"></i>
                        <h5>Validation</h5>
                        <h3 id="validationStatus" class="text-warning">-</h3>
                        <small class="text-muted">Status</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card calibration-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-info mb-2"></i>
                        <h5>Last Calibration</h5>
                        <h3 id="lastCalibration" class="text-info">-</h3>
                        <small class="text-muted">Days Ago</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Control Panel -->
        <div class="row">
            <div class="col-md-8">
                <!-- Calibration Process -->
                <div class="card calibration-card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> Calibration Process</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress-container">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Calibration Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div id="calibrationProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-2">
                                <small id="progressStatus" class="text-muted">Ready to start calibration</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <button id="btnLoadData" class="btn btn-outline-primary w-100 mb-2">
                                    <i class="fas fa-download"></i> Load Existing Data
                                </button>
                                <button id="btnCalculateCorrections" class="btn btn-outline-success w-100 mb-2" disabled>
                                    <i class="fas fa-calculator"></i> Calculate Corrections
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="btnValidate" class="btn btn-outline-warning w-100 mb-2" disabled>
                                    <i class="fas fa-check"></i> Validate Calibration
                                </button>
                                <button id="btnGenerateReport" class="btn btn-outline-info w-100 mb-2" disabled>
                                    <i class="fas fa-file-pdf"></i> Generate Report
                                </button>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-12">
                                <button id="btnFullCalibration" class="btn btn-primary w-100">
                                    <i class="fas fa-magic"></i> Execute Full Calibration Process
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Registered Instruments -->
                <div class="card calibration-card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> Registered Instruments</h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addInstrumentModal">
                            <i class="fas fa-plus"></i> Add Instrument
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="instrumentsList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading instruments...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Quick Actions -->
                <div class="card calibration-card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Apply Correction</label>
                            <div class="input-group mb-2">
                                <input type="text" id="instrumentId" class="form-control" placeholder="Instrument ID">
                            </div>
                            <div class="input-group mb-2">
                                <select id="parameterType" class="form-select">
                                    <option value="current">Current</option>
                                    <option value="voltage">Voltage</option>
                                </select>
                            </div>
                            <div class="input-group mb-2">
                                <input type="number" id="rawValue" class="form-control" placeholder="Raw Value" step="any">
                            </div>
                            <button id="btnApplyCorrection" class="btn btn-primary w-100">
                                <i class="fas fa-calculator"></i> Apply Correction
                            </button>
                        </div>

                        <div id="correctionResult" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Corrected Value:</strong> <span id="correctedValue">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="card calibration-card">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat"></i> System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <span class="status-indicator status-active"></span>
                            <strong>Calibration System:</strong> Active
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator status-active"></span>
                            <strong>Database:</strong> Connected
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator" id="dataStatus"></span>
                            <strong>Data Loading:</strong> <span id="dataStatusText">Ready</span>
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator" id="validationStatusIndicator"></span>
                            <strong>Validation:</strong> <span id="validationStatusText">Pending</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Results -->
        <div class="row mt-4" id="validationResults" style="display: none;">
            <div class="col-12">
                <div class="card calibration-card">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-check"></i> Validation Results</h5>
                    </div>
                    <div class="card-body" id="validationContent">
                        <!-- Validation results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Instrument Modal -->
    <div class="modal fade" id="addInstrumentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Instrument</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addInstrumentForm">
                        <div class="mb-3">
                            <label for="newInstrumentId" class="form-label">Instrument ID *</label>
                            <input type="text" class="form-control" id="newInstrumentId" required>
                        </div>
                        <div class="mb-3">
                            <label for="newInstrumentType" class="form-label">Instrument Type *</label>
                            <select class="form-select" id="newInstrumentType" required>
                                <option value="">Select Type</option>
                                <option value="H743">H743 Potentiostat</option>
                                <option value="PalmSens">PalmSens</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newSerialNumber" class="form-label">Serial Number</label>
                            <input type="text" class="form-control" id="newSerialNumber">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveInstrument">Save Instrument</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dashboard JavaScript functionality
        class CalibrationDashboard {
            constructor() {
                this.apiBase = '/api/calibration';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadSystemStatus();
                this.loadInstruments();
                this.updateLastUpdated();
            }

            setupEventListeners() {
                // Main action buttons
                document.getElementById('btnLoadData').addEventListener('click', () => this.loadExistingData());
                document.getElementById('btnCalculateCorrections').addEventListener('click', () => this.calculateCorrections());
                document.getElementById('btnValidate').addEventListener('click', () => this.validateCalibration());
                document.getElementById('btnGenerateReport').addEventListener('click', () => this.generateReport());
                document.getElementById('btnFullCalibration').addEventListener('click', () => this.executeFullCalibration());

                // Quick actions
                document.getElementById('btnApplyCorrection').addEventListener('click', () => this.applyCorrection());

                // Modal actions
                document.getElementById('btnSaveInstrument').addEventListener('click', () => this.saveNewInstrument());
            }

            async apiCall(endpoint, method = 'GET', data = null) {
                try {
                    const options = {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    };

                    if (data && method !== 'GET') {
                        options.body = JSON.stringify(data);
                    }

                    const response = await fetch(`${this.apiBase}${endpoint}`, options);
                    return await response.json();
                } catch (error) {
                    console.error('API call failed:', error);
                    return { status: 'error', message: error.message };
                }
            }

            async loadSystemStatus() {
                const result = await this.apiCall('/status');
                if (result.status === 'success') {
                    const data = result.data;
                    document.getElementById('instrumentCount').textContent = data.instruments_count;
                    document.getElementById('correctionCount').textContent = data.correction_factors_count;
                } else {
                    this.showAlert('Failed to load system status', 'warning');
                }
            }

            async loadInstruments() {
                const result = await this.apiCall('/instruments');
                const container = document.getElementById('instrumentsList');
                
                if (result.status === 'success') {
                    const instruments = result.data.instruments;
                    
                    if (Object.keys(instruments).length === 0) {
                        container.innerHTML = '<div class="text-center text-muted">No instruments registered</div>';
                    } else {
                        let html = '';
                        for (const [id, info] of Object.entries(instruments)) {
                            html += `
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <div>
                                        <strong>${id}</strong><br>
                                        <small class="text-muted">${info.type} | ${info.serial || 'No S/N'}</small>
                                    </div>
                                    <span class="badge bg-success">Active</span>
                                </div>
                            `;
                        }
                        container.innerHTML = html;
                    }
                } else {
                    container.innerHTML = '<div class="text-center text-danger">Failed to load instruments</div>';
                }
            }

            async loadExistingData() {
                this.updateProgress(25, 'Loading existing calibration data...');
                const result = await this.apiCall('/load_existing_data', 'POST');
                
                if (result.status === 'success') {
                    this.updateProgress(25, 'Data loaded successfully');
                    this.updateSystemStatus('dataStatus', 'status-active', 'Loaded');
                    document.getElementById('btnCalculateCorrections').disabled = false;
                    this.showAlert('Existing calibration data loaded successfully', 'success');
                } else {
                    this.updateProgress(0, 'Failed to load data');
                    this.showAlert(result.message, 'danger');
                }
            }

            async calculateCorrections() {
                this.updateProgress(50, 'Calculating correction factors...');
                const result = await this.apiCall('/calculate_corrections', 'POST');
                
                if (result.status === 'success') {
                    this.updateProgress(50, 'Correction factors calculated');
                    document.getElementById('btnValidate').disabled = false;
                    this.showAlert('Correction factors calculated successfully', 'success');
                    await this.loadSystemStatus(); // Refresh counts
                } else {
                    this.updateProgress(25, 'Failed to calculate corrections');
                    this.showAlert(result.message, 'danger');
                }
            }

            async validateCalibration() {
                this.updateProgress(75, 'Validating calibration...');
                const result = await this.apiCall('/validate', 'POST');
                
                if (result.status === 'success') {
                    this.updateProgress(75, 'Validation completed');
                    this.displayValidationResults(result.data);
                    document.getElementById('btnGenerateReport').disabled = false;
                    
                    const status = result.data.overall_status;
                    this.updateSystemStatus('validationStatusIndicator', 
                        status === 'PASS' ? 'status-active' : 'status-error', 
                        status);
                    document.getElementById('validationStatus').textContent = status;
                    document.getElementById('validationStatus').className = 
                        `text-${status === 'PASS' ? 'success' : 'danger'}`;
                } else {
                    this.updateProgress(50, 'Validation failed');
                    this.showAlert(result.message, 'danger');
                }
            }

            async generateReport() {
                this.updateProgress(100, 'Generating calibration report...');
                const result = await this.apiCall('/report');
                
                if (result.status === 'success') {
                    this.updateProgress(100, 'Report generated successfully');
                    this.showAlert(`Report generated: ${result.data.report_path}`, 'success');
                } else {
                    this.updateProgress(75, 'Failed to generate report');
                    this.showAlert(result.message, 'danger');
                }
            }

            async executeFullCalibration() {
                this.updateProgress(0, 'Starting full calibration process...');
                const result = await this.apiCall('/batch/full_calibration', 'POST');
                
                if (result.status === 'success') {
                    this.updateProgress(100, 'Full calibration completed successfully');
                    this.showAlert('Full calibration process completed successfully', 'success');
                    
                    // Enable all buttons
                    document.getElementById('btnCalculateCorrections').disabled = false;
                    document.getElementById('btnValidate').disabled = false;
                    document.getElementById('btnGenerateReport').disabled = false;
                    
                    // Refresh all data
                    await this.loadSystemStatus();
                    await this.loadInstruments();
                } else {
                    this.updateProgress(0, 'Full calibration failed');
                    this.showAlert(result.message, 'danger');
                }
            }

            async applyCorrection() {
                const instrumentId = document.getElementById('instrumentId').value;
                const parameterType = document.getElementById('parameterType').value;
                const rawValue = document.getElementById('rawValue').value;

                if (!instrumentId || !rawValue) {
                    this.showAlert('Please fill in all required fields', 'warning');
                    return;
                }

                const result = await this.apiCall('/apply_correction', 'POST', {
                    instrument_id: instrumentId,
                    parameter_type: parameterType,
                    raw_value: parseFloat(rawValue)
                });

                if (result.status === 'success') {
                    const data = result.data;
                    document.getElementById('correctedValue').textContent = data.corrected_value.toFixed(6);
                    document.getElementById('correctionResult').style.display = 'block';
                } else {
                    this.showAlert(result.message, 'danger');
                }
            }

            async saveNewInstrument() {
                const instrumentId = document.getElementById('newInstrumentId').value;
                const instrumentType = document.getElementById('newInstrumentType').value;
                const serialNumber = document.getElementById('newSerialNumber').value;

                if (!instrumentId || !instrumentType) {
                    this.showAlert('Please fill in all required fields', 'warning');
                    return;
                }

                const result = await this.apiCall('/instruments/register', 'POST', {
                    instrument_id: instrumentId,
                    instrument_type: instrumentType,
                    serial_number: serialNumber
                });

                if (result.status === 'success') {
                    this.showAlert('Instrument registered successfully', 'success');
                    document.getElementById('addInstrumentForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addInstrumentModal')).hide();
                    await this.loadInstruments();
                    await this.loadSystemStatus();
                } else {
                    this.showAlert(result.message, 'danger');
                }
            }

            displayValidationResults(results) {
                const container = document.getElementById('validationContent');
                const resultsSection = document.getElementById('validationResults');
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Overall Status: <span class="badge bg-${results.overall_status === 'PASS' ? 'success' : 'danger'}">${results.overall_status}</span></h6>
                            <p class="text-muted">Validation completed at: ${new Date(results.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Test Results:</h6>
                `;

                for (const [testName, testData] of Object.entries(results.tests)) {
                    const statusClass = testData.passed ? 'pass' : 'fail';
                    const statusText = testData.passed ? 'PASS' : 'FAIL';
                    
                    html += `
                        <div class="validation-test ${statusClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>${testData.test_name}</strong>
                                <span class="badge bg-${testData.passed ? 'success' : 'danger'}">${statusText}</span>
                            </div>
                    `;
                    
                    if (testData.details && testData.details.length > 0) {
                        html += '<ul class="mt-2 mb-0">';
                        testData.details.forEach(detail => {
                            html += `<li><small>${detail}</small></li>`;
                        });
                        html += '</ul>';
                    }
                    
                    html += '</div>';
                }

                container.innerHTML = html;
                resultsSection.style.display = 'block';
            }

            updateProgress(percent, status) {
                document.getElementById('calibrationProgress').style.width = `${percent}%`;
                document.getElementById('progressPercent').textContent = `${percent}%`;
                document.getElementById('progressStatus').textContent = status;
            }

            updateSystemStatus(elementId, statusClass, statusText) {
                const element = document.getElementById(elementId);
                element.className = `status-indicator ${statusClass}`;
                const textElement = document.getElementById(elementId.replace('Status', 'StatusText'));
                if (textElement) {
                    textElement.textContent = statusText;
                }
            }

            updateLastUpdated() {
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                
                // Update every minute
                setInterval(() => {
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                }, 60000);
            }

            showAlert(message, type) {
                // Create and show bootstrap alert
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert at top of container
                const container = document.querySelector('.container');
                container.insertBefore(alertDiv, container.firstChild);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CalibrationDashboard();
        });
    </script>
</body>
</html>
