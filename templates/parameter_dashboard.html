{% extends "base.html" %}

{% block title %}Parameter Management Dashboard{% endblock %}

{% block content %}
<div class="parameter-dashboard">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4">ðŸ“Š Parameter Management Dashboard</h1>
                <p class="lead">Manage measurement parameters and calibration data</p>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-sliders-h"></i> Control Panel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="sampleFilter" class="form-label">Filter by Sample:</label>
                                <select id="sampleFilter" class="form-select">
                                    <option value="">All Samples</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="instrumentFilter" class="form-label">Filter by Instrument:</label>
                                <select id="instrumentFilter" class="form-select">
                                    <option value="">All Instruments</option>
                                    <option value="palmsens">Palmsens (Reference)</option>
                                    <option value="stm32">STM32 (Target)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="scanRateFilter" class="form-label">Filter by Scan Rate:</label>
                                <select id="scanRateFilter" class="form-select">
                                    <option value="">All Scan Rates</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions:</label>
                                <div class="btn-group d-block" role="group">
                                    <button id="refreshBtn" class="btn btn-primary">
                                        <i class="fas fa-refresh"></i> Refresh
                                    </button>
                                    <button id="exportBtn" class="btn btn-success">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Batch Selection Controls -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">Batch Processing</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span id="selectedInfo">0 measurement(s) selected</span>
                                            <div id="groupInfo"></div>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
                                            <button id="clearSelectionBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                                            <button id="groupByScanRateBtn" class="btn btn-sm btn-outline-info">Group by Scan Rate</button>
                                            <button id="processSelectedBtn" class="btn btn-sm btn-warning">
                                                <i class="fas fa-calculator"></i> Calculate Statistics
                                            </button>
                                            <button id="viewAveragedGraphBtn" class="btn btn-sm btn-success">
                                                <i class="fas fa-chart-area"></i> View Averaged Graph
                                            </button>
                                            <button id="batchDeleteBtn" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i> Delete Selected
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="totalMeasurements">0</h4>
                                <p class="card-text">Total Measurements</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="referenceMeasurements">0</h4>
                                <p class="card-text">Reference (Palmsens)</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-microscope fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="targetMeasurements">0</h4>
                                <p class="card-text">Target (STM32)</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-microchip fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="calibrationPairs">0</h4>
                                <p class="card-text">Calibration Pairs</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-link fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Measurements Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table"></i> Measurements
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="measurementsTable" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox" 
                                                   onchange="parameterDashboard.toggleSelectAll(this.checked)">
                                        </th>
                                        <th>ID</th>
                                        <th>Sample ID</th>
                                        <th>Instrument</th>
                                        <th>Timestamp</th>
                                        <th>Scan Rate</th>
                                        <th>Voltage Range</th>
                                        <th>Data Points</th>
                                        <th>Peaks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Peak Details Modal -->
        <div class="modal fade" id="peakDetailsModal" tabindex="-1" aria-labelledby="peakDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="peakDetailsModalLabel">Peak Parameters</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="peakDetailsContent">
                            <!-- Peak details will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="exportPeaksBtn">Export Peaks</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calibration Modal -->
        <div class="modal fade" id="calibrationModal" tabindex="-1" aria-labelledby="calibrationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="calibrationModalLabel">Create Calibration Session</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="calibrationForm">
                            <div class="mb-3">
                                <label for="sessionName" class="form-label">Session Name</label>
                                <input type="text" class="form-control" id="sessionName" required>
                            </div>
                            <div class="mb-3">
                                <label for="referenceMeasurement" class="form-label">Reference Measurement (Palmsens)</label>
                                <select class="form-select" id="referenceMeasurement" required>
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="targetMeasurement" class="form-label">Target Measurement (STM32)</label>
                                <select class="form-select" id="targetMeasurement" required>
                                    <!-- Options populated by JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="calibrationMethod" class="form-label">Calibration Method</label>
                                <select class="form-select" id="calibrationMethod">
                                    <option value="linear">Linear Regression</option>
                                    <option value="polynomial">Polynomial Fit</option>
                                    <option value="spline">Spline Interpolation</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="calibrationNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="calibrationNotes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="createCalibrationBtn">Create Session</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Averaged Graph Modal -->
        <div class="modal fade" id="averagedGraphModal" tabindex="-1" aria-labelledby="averagedGraphModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="averagedGraphModalLabel">Averaged CV Graph with Error Bars</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="averagedGraphInfo" class="alert alert-info mb-3">
                            <!-- Graph information will be populated here -->
                        </div>
                        <div id="averagedGraph" style="height: 500px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="exportAveragedGraphBtn">
                            <i class="fas fa-download"></i> Export Graph
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                <p id="deleteMessage">Are you sure you want to delete this measurement?</p>
                <div id="deleteDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script src="{{ url_for('static', filename='js/parameter_dashboard.js') }}"></script>
{% endblock %}