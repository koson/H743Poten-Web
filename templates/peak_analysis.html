<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peak Analysis Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .peak-visualization-container {
            width: 100%;
            height: 600px;
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #cvPlot {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 4px;
        }

        .data-info, .peak-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .peak-info {
            margin-bottom: 20px;
        }

        .peak-info .card-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
        }

        .peak-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .peak-item {
            padding: 0.75rem;
            background: white;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .peak-item:last-child {
            border-bottom: none;
        }

        .peak-item:hover {
            background-color: #f8f9fa;
        }

        .peak-item.selected {
            background-color: #e9ecef;
        }

        .peak-type {
            margin-bottom: 0.4rem;
        }

        .type-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
        }

        .type-badge.oxidation {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .type-badge.reduction {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .peak-values {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
        }

        .value-label {
            color: #6c757d;
            font-weight: 500;
        }

        .value {
            color: #212529;
        }

        .peak-confidence {
            font-size: 0.75rem;
        }

        .controls {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .toolbar {
            margin-bottom: 20px;
        }

        .toolbar button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2>Peak Analysis Details</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="peak-visualization-container">
                    <canvas id="cvPlot"></canvas>
                </div>
            </div>
            <div class="col-md-3">
                <div class="controls mb-3">
                    <button id="exportPeakDataBtn" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                    <button id="toggleGridBtn" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                        <i class="bi bi-grid"></i> Toggle Grid
                    </button>
                    <button id="resetViewBtn" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset View
                    </button>
                </div>
                <div class="data-info mb-3">
                    <!-- Data information will be populated here -->
                </div>
                <div class="peak-info card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Peak Information</h6>
                        <span class="badge bg-success">Active Method</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="peak-list">
                            <!-- Peak list will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="peak-details">
                    <!-- Peak details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/peak_graph_utils.js"></script>
    <script src="/static/js/peak_canvas_manager.js"></script>
    <script>
        // Initialize canvas manager
        let canvasManager;
        // Get data from template variables
        const peaks = {{ peaks|tojson }};
        const data = {{ data|tojson }};

        // Initialize visualization when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('cvPlot');
            const container = canvas.parentElement;

            // Initialize canvas
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // Create canvas manager
            canvasManager = {
                canvas: canvas,
                context: canvas.getContext('2d'),
                data: data.previewData,
                method: method,
                
                initialize() {
                    console.log('Initializing canvas manager with data:', this.data);
                    this.drawPlot();
                    return true;
                },

                drawPlot() {
                    if (!this.data) {
                        console.error('No data available');
                        return;
                    }

                    const width = this.canvas.width;
                    const height = this.canvas.height;
                    const padding = 40;

                    // Clear canvas
                    this.context.clearRect(0, 0, width, height);
                    this.context.fillStyle = '#ffffff';
                    this.context.fillRect(0, 0, width, height);

                    // Calculate ranges
                    const xMin = Math.min(...this.data.voltage);
                    const xMax = Math.max(...this.data.voltage);
                    const yMin = Math.min(...this.data.current);
                    const yMax = Math.max(...this.data.current);

                    // Add padding to ranges
                    const xPadding = (xMax - xMin) * 0.1;
                    const yPadding = (yMax - yMin) * 0.1;

                    // Scale factors
                    const xScale = (width - 2 * padding) / ((xMax + xPadding) - (xMin - xPadding));
                    const yScale = (height - 2 * padding) / ((yMax + yPadding) - (yMin - yPadding));

                    // Drawing functions
                    const toCanvasX = x => padding + (x - (xMin - xPadding)) * xScale;
                    const toCanvasY = y => height - (padding + (y - (yMin - yPadding)) * yScale);

                    // Draw grid
                    this.context.strokeStyle = '#f0f0f0';
                    this.context.lineWidth = 1;

                    // Vertical grid lines
                    for (let x = Math.floor(xMin); x <= Math.ceil(xMax); x += (xMax - xMin) / 10) {
                        this.context.beginPath();
                        this.context.moveTo(toCanvasX(x), padding);
                        this.context.lineTo(toCanvasX(x), height - padding);
                        this.context.stroke();
                    }

                    // Horizontal grid lines
                    for (let y = Math.floor(yMin); y <= Math.ceil(yMax); y += (yMax - yMin) / 10) {
                        this.context.beginPath();
                        this.context.moveTo(padding, toCanvasY(y));
                        this.context.lineTo(width - padding, toCanvasY(y));
                        this.context.stroke();
                    }

                    // Draw axes
                    this.context.strokeStyle = '#000000';
                    this.context.lineWidth = 2;
                    this.context.beginPath();
                    this.context.moveTo(padding, padding);
                    this.context.lineTo(padding, height - padding);
                    this.context.lineTo(width - padding, height - padding);
                    this.context.stroke();

                    // Draw axis labels
                    this.context.font = '14px Arial';
                    this.context.fillStyle = '#000000';
                    
                    // X-axis label
                    this.context.textAlign = 'center';
                    this.context.textBaseline = 'top';
                    this.context.fillText('Voltage (V)', width / 2, height - padding / 2);
                    
                    // Y-axis label
                    this.context.save();
                    this.context.translate(padding / 2, height / 2);
                    this.context.rotate(-Math.PI / 2);
                    this.context.textAlign = 'center';
                    this.context.fillText('Current (µA)', 0, 0);
                    this.context.restore();

                    // Draw axis values
                    this.context.font = '12px Arial';
                    
                    // X-axis values
                    for (let x = xMin; x <= xMax; x += (xMax - xMin) / 5) {
                        const xPos = toCanvasX(x);
                        this.context.textAlign = 'center';
                        this.context.textBaseline = 'top';
                        this.context.fillText(x.toFixed(2), xPos, height - padding + 5);
                    }

                    // Y-axis values
                    for (let y = yMin; y <= yMax; y += (yMax - yMin) / 5) {
                        const yPos = toCanvasY(y);
                        this.context.textAlign = 'right';
                        this.context.textBaseline = 'middle';
                        this.context.fillText(y.toFixed(2), padding - 5, yPos);
                    }

                    // Draw CV curve
                    this.context.strokeStyle = '#0d6efd';
                    this.context.lineWidth = 2;
                    this.context.beginPath();
                    this.context.moveTo(toCanvasX(this.data.voltage[0]), toCanvasY(this.data.current[0]));

                    for (let i = 1; i < this.data.voltage.length; i++) {
                        this.context.lineTo(toCanvasX(this.data.voltage[i]), toCanvasY(this.data.current[i]));
                    }

                    this.context.stroke();

                    // Draw peaks
                    this.data.peaks.forEach(peak => {
                        // Draw peak point
                        this.context.fillStyle = peak.type === 'oxidation' ? '#dc3545' : '#198754';
                        this.context.beginPath();
                        this.context.arc(toCanvasX(peak.x), toCanvasY(peak.y), 6, 0, 2 * Math.PI);
                        this.context.fill();

                        // Draw peak label
                        this.context.font = '12px Arial';
                        this.context.fillStyle = '#000000';
                        this.context.textAlign = 'center';
                        this.context.textBaseline = 'bottom';
                        this.context.fillText(peak.type === 'oxidation' ? 'Ox' : 'Red', 
                                            toCanvasX(peak.x), 
                                            toCanvasY(peak.y) - 10);
                    });
                },

                highlightPeak(peak) {
                    this.drawPlot();  // Redraw everything
                    
                    // Add extra highlight for selected peak
                    const width = this.canvas.width;
                    const height = this.canvas.height;
                    const padding = 40;
                    
                    const xMin = Math.min(...this.data.voltage);
                    const xMax = Math.max(...this.data.voltage);
                    const yMin = Math.min(...this.data.current);
                    const yMax = Math.max(...this.data.current);
                    
                    const xPadding = (xMax - xMin) * 0.1;
                    const yPadding = (yMax - yMin) * 0.1;
                    
                    const xScale = (width - 2 * padding) / ((xMax + xPadding) - (xMin - xPadding));
                    const yScale = (height - 2 * padding) / ((yMax + yPadding) - (yMin - yPadding));
                    
                    const toCanvasX = x => padding + (x - (xMin - xPadding)) * xScale;
                    const toCanvasY = y => height - (padding + (y - (yMin - yPadding)) * yScale);
                    
                    // Draw highlight circle
                    this.context.strokeStyle = peak.type === 'oxidation' ? '#dc3545' : '#198754';
                    this.context.lineWidth = 2;
                    this.context.beginPath();
                    this.context.arc(toCanvasX(peak.x), toCanvasY(peak.y), 12, 0, 2 * Math.PI);
                    this.context.stroke();
                }
            };

            // Initialize canvas manager
            if (canvasManager.initialize()) {
                // Update peak list
                updatePeakList(data.previewData.peaks);
                // Update data info
                updateDataInfo(data);
            }

            // Setup toolbar buttons
            setupToolbar();
        });

        function updatePeakList(peaks) {
            const peakList = document.querySelector('.peak-list');
            peakList.innerHTML = peaks.map((peak, index) => `
                <div class="peak-item" data-index="${index}">
                    <div class="peak-type">
                        <span class="type-badge ${peak.type}">${peak.type}</span>
                    </div>
                    <div class="peak-values">
                        <div><span class="value-label">V:</span> <span class="value">${peak.x.toFixed(3)}</span></div>
                        <div><span class="value-label">i:</span> <span class="value">${peak.y.toFixed(3)}</span></div>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            peakList.querySelectorAll('.peak-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.peak-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    const index = parseInt(item.dataset.index);
                    highlightPeak(peaks[index]);
                });
            });
        }

        function updateDataInfo(data) {
            const dataInfo = document.querySelector('.data-info');
            dataInfo.innerHTML = `
                <h6 class="mb-3">Analysis Summary</h6>
                <div class="mb-2">
                    <strong>Method:</strong> ${method}
                </div>
                <div class="mb-2">
                    <strong>Peaks Detected:</strong> ${data.peaks}
                </div>
                <div class="mb-2">
                    <strong>Confidence:</strong> ${data.confidence}%
                </div>
                <div>
                    <strong>Processing Time:</strong> ${data.processingTime}s
                </div>
            `;
        }

        function highlightPeak(peak) {
            if (window.peakCanvasManager) {
                peakCanvasManager.highlightPeak(peak);
            }
        }

        function setupToolbar() {
            // Export Data
            document.getElementById('exportPeakDataBtn').addEventListener('click', () => {
                const csvContent = generateCSV(data);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `peak_analysis_${method}_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            });

            // Toggle Grid
            document.getElementById('toggleGridBtn').addEventListener('click', () => {
                if (window.peakCanvasManager) {
                    peakCanvasManager.toggleGrid();
                }
            });

            // Reset View
            document.getElementById('resetViewBtn').addEventListener('click', () => {
                if (window.peakCanvasManager) {
                    peakCanvasManager.resetView();
                }
            });
        }

        function generateCSV(data) {
            const rows = [
                ['Method', method],
                ['Peaks Detected', data.peaks],
                ['Confidence', data.confidence + '%'],
                ['Processing Time', data.processingTime + 's'],
                [],
                ['Peak Analysis Results'],
                ['Type', 'Voltage (V)', 'Current (µA)']
            ];

            data.previewData.peaks.forEach(peak => {
                rows.push([peak.type, peak.x.toFixed(3), peak.y.toFixed(3)]);
            });

            return rows.map(row => row.join(',')).join('\n');
        }
    </script>
</body>
</html>