<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peak Analysis Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .peak-visualization-container {
            width: 100%;
            height: 600px;
            position: relative;
            z-index: 0;  /* Keep canvas behind DevTools */
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #cvPlot {
            width: 100% !important;
            height: 100% !important;
            background: white;
            border-radius: 4px;
            /* Ensure chart fills container */
            display: block;
            box-sizing: border-box;
        }

        .data-info, .peak-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .peak-info {
            margin-bottom: 20px;
        }

        .peak-info .card-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
        }

        .peak-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .peak-item {
            padding: 0.75rem;
            background: white;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .peak-item:last-child {
            border-bottom: none;
        }

        .peak-item:hover {
            background-color: #f8f9fa;
        }

        .peak-item.selected {
            background-color: #e9ecef;
        }

        .peak-type {
            margin-bottom: 0.4rem;
        }

        .type-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
        }

        .type-badge.oxidation {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .type-badge.reduction {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .peak-values {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
        }

        .value-label {
            color: #6c757d;
            font-weight: 500;
        }

        .value {
            color: #212529;
        }

        .peak-confidence {
            font-size: 0.75rem;
        }

        .controls {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .toolbar {
            margin-bottom: 20px;
        }

        .toolbar button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2>Peak Analysis Details</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="peak-visualization-container">
                    <canvas id="cvPlot"></canvas>
                </div>
            </div>
            <div class="col-md-3">
                <div class="controls mb-3">
                    <button id="exportPeakDataBtn" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                </div>
                <div class="data-info mb-3">
                    <!-- Data information will be populated here -->
                </div>
                <div class="peak-info card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Peak Information</h6>
                        <span class="badge bg-success">Active Method</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="peak-list">
                            <!-- Peak list will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="peak-details">
                    <!-- Peak details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Load Chart.js and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script>
        // Register plugins globally after they're loaded
        window.addEventListener('load', function() {
            if (Chart.register) {
                const zoomPlugin = window.ChartZoom || Chart.plugins?.zoom;
                const annotationPlugin = window.ChartAnnotation;
                
                if (zoomPlugin) {
                    Chart.register(zoomPlugin);
                    console.log('Zoom plugin registered globally');
                }
                
                if (annotationPlugin) {
                    Chart.register(annotationPlugin);
                    console.log('Annotation plugin registered globally');
                }
            }
        });
    </script>
    <script>
        function initChartPlugins(callback) {
            console.log('Initializing plugins...');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded, retrying in 100ms');
                setTimeout(() => initChartPlugins(callback), 100);
                return;
            }

            // Wait for zoom plugin to be registered
            function waitForZoomPlugin() {
                const zoomAvailable = !!Chart.Zoom || !!window.ChartZoom || 
                                    (Chart.registry && Chart.registry.plugins.get('zoom'));
                
                console.log('Chart.js version:', Chart.version);
                console.log('Zoom plugin available:', zoomAvailable);
                console.log('Hammer.js available:', !!window.Hammer);
                
                if (zoomAvailable) {
                    // Force enable pan and zoom
                    if (Chart.defaults && Chart.defaults.plugins && Chart.defaults.plugins.zoom) {
                        Chart.defaults.plugins.zoom.pan.enabled = true;
                        Chart.defaults.plugins.zoom.zoom.wheel.enabled = true;
                        console.log('Enabled pan and zoom in defaults');
                    }
                    
                    console.log('Ready to initialize chart');
                    callback();
                } else {
                    console.log('Waiting for zoom plugin...');
                    setTimeout(waitForZoomPlugin, 200);
                }
            }
            
            waitForZoomPlugin();
        }

        // Get data from template variables passed from Flask
        const peaksData = {{ peaks|tojson|safe }};
        const chartData = {{ data|tojson|safe }};
        const methodType = {{ method|tojson|safe }};
        const methodNameStr = {{ methodName|tojson|safe }};

        // Initialize visualization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize plugins first
            initChartPlugins(function() {
            const canvas = document.getElementById('cvPlot');
            const container = canvas.parentElement;

            const ctx = canvas.getContext('2d');
            console.log('Creating chart...');
            window.peakChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'CV Data',
                                                    data: chartData.voltage.map((v, i) => ({
                            x: v,
                            y: chartData.current[i]
                        })),
                        borderColor: '#0d6efd',
                        borderWidth: 2,
                        showLine: true,
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'Peaks',
                        data: peaksData.map(peak => ({
                            x: peak.x,
                            y: peak.y,
                            type: peak.type
                        })),
                        backgroundColor: d => d.raw.type === 'oxidation' ? '#dc3545' : '#198754',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy'
                            }
                        },
                        annotation: {
                            annotations: {
                                // Peak labels
                                ...Object.fromEntries(peaksData.map((peak, i) => [
                                    `peak${i}`, {
                                        type: 'label',
                                        xValue: peak.x,
                                        yValue: peak.y,
                                        yAdjust: -10,
                                        content: peak.type === 'oxidation' ? 'Ox' : 'Red',
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        },
                                        color: peak.type === 'oxidation' ? '#dc3545' : '#198754',
                                        backgroundColor: 'rgba(255,255,255,0.8)',
                                        borderRadius: 4,
                                        padding: 4
                                    }
                                ])),
                                // Peak value labels
                                ...Object.fromEntries(peaksData.map((peak, i) => [
                                    `peakValue${i}`, {
                                        type: 'label',
                                        xValue: peak.x,
                                        yValue: peak.y,
                                        yAdjust: 15,
                                        content: `${peak.y.toFixed(2)} µA`,
                                        font: {
                                            size: 11
                                        },
                                        color: '#666666',
                                        backgroundColor: 'rgba(255,255,255,0.8)',
                                        borderRadius: 3,
                                        padding: 2
                                    }
                                ]))
                            }
                        },
                        tooltip: {
                            enabled: true,
                            position: 'nearest',
                            intersect: false,
                            callbacks: {
                                label: (context) => {
                                    if (context.datasetIndex === 0) {
                                        return `V: ${context.parsed.x.toFixed(3)} V, i: ${context.parsed.y.toFixed(3)} µA`;
                                    } else {
                                        const peak = context.raw;
                                        return `${peak.type} peak at ${peak.x.toFixed(3)} V, ${peak.y.toFixed(3)} µA`;
                                    }
                                }
                            }
                        },
                        legend: {
                            display: false  // Hide legend as it's not needed
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: Math.min(...chartData.voltage) * 1.1,
                            max: Math.max(...chartData.voltage) * 1.1,
                            title: {
                                display: true,
                                text: 'Voltage (V)',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10,
                                callback: value => value.toFixed(3)
                            },
                            grid: {
                                display: true,
                                color: '#f0f0f0',
                                drawBorder: true
                            }
                        },
                        y: {
                            type: 'linear',
                            min: Math.min(...chartData.current) * 1.1,
                            max: Math.max(...chartData.current) * 1.1,
                            title: {
                                display: true,
                                text: 'Current (µA)',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10,
                                callback: value => value.toFixed(3)
                            },
                            grid: {
                                display: true,
                                color: '#f0f0f0',
                                drawBorder: true
                            }
                        }
                    }
                }
            });

            // Export old canvas manager interface for compatibility
            window.peakCanvasManager = {
                showGrid: true, // Track grid visibility
                canvas: canvas,
                context: canvas.getContext('2d'),
                data: chartData,
                method: methodType,
                initialize() {
                    return true;
                },

                resetView() {
                    if (window.peakChart) {
                        window.peakChart.resetZoom();
                    }
                },

                highlightPeak(peak) {
                    if (window.peakChart) {
                        // Update annotation colors and sizes for all peaks
                        window.peakChart.options.plugins.annotation.annotations = peaksData.map(p => ({
                            type: 'label',
                            xValue: p.x,
                            yValue: p.y,
                            yAdjust: -10,
                            content: p.type === 'oxidation' ? 'Ox' : 'Red',
                            font: {
                                size: p === peak ? 14 : 12,  // Larger font for selected peak
                                weight: p === peak ? 'bold' : 'normal'  // Bold for selected peak
                            },
                            color: p === peak ? (p.type === 'oxidation' ? '#dc3545' : '#198754') : '#000000'
                        }));

                        // Update peak point sizes
                        window.peakChart.data.datasets[1].pointRadius = peaksData.map(p => p === peak ? 8 : 6);
                        window.peakChart.data.datasets[1].pointHoverRadius = peaksData.map(p => p === peak ? 10 : 8);

                        window.peakChart.update();
                    }
                }
            };

            // Initialize canvas manager
            if (window.peakCanvasManager.initialize()) {
                // Update peak list
                updatePeakList(peaksData);
                // Update data info
                updateDataInfo(chartData);
            }

            // Setup toolbar buttons
            setupToolbar();
            });
        });

        function updatePeakList(peaks) {
            const peakList = document.querySelector('.peak-list');
            peakList.innerHTML = peaks.map((peak, index) => `
                <div class="peak-item" data-index="${index}">
                    <div class="peak-type">
                        <span class="type-badge ${peak.type}">${peak.type}</span>
                    </div>
                    <div class="peak-values">
                        <div><span class="value-label">V:</span> <span class="value">${peak.x.toFixed(3)}</span></div>
                        <div><span class="value-label">i:</span> <span class="value">${peak.y.toFixed(3)}</span></div>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            peakList.querySelectorAll('.peak-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.peak-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    const index = parseInt(item.dataset.index);
                    highlightPeak(peaks[index]);
                });
            });
        }

        function updateDataInfo(data) {
            const dataInfo = document.querySelector('.data-info');
            dataInfo.innerHTML = `
                <h6 class="mb-3">Analysis Summary</h6>
                <div class="mb-2">
                    <strong>Method:</strong> ${methodNameStr}
                </div>
                <div class="mb-2">
                    <strong>Peaks Detected:</strong> ${peaksData.length}
                </div>
                <div class="mb-2">
                    <strong>Data Points:</strong> ${chartData.voltage.length}
                </div>
                <div>
                    <strong>Analysis:</strong> Complete
                </div>
            `;
        }

        function highlightPeak(peak) {
            if (window.peakCanvasManager) {
                peakCanvasManager.highlightPeak(peak);
            }
        }

        function setupToolbar() {
            // Export Data
            document.getElementById('exportPeakDataBtn').addEventListener('click', function() {
                const csvContent = generateCSV(chartData);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `peak_analysis_${methodType}_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            });

            console.log('Setting up chart handlers...');
            
            if (window.peakChart) {
                console.log('Chart is ready, setting up handlers');
                const canvas = document.getElementById('cvPlot');
                
                // Verify zoom plugin is attached to this chart
                const chartPlugins = window.peakChart.config.plugins || [];
                console.log('Chart plugins:', chartPlugins.map(p => p.id || p.constructor.name));
                
                // Check if zoom options are properly set
                console.log('Chart zoom options:', window.peakChart.options.plugins?.zoom);
                
                // Force enable pan on the chart instance
                if (window.peakChart.options.plugins?.zoom) {
                    window.peakChart.options.plugins.zoom.pan.enabled = true;
                    window.peakChart.options.plugins.zoom.pan.mode = 'xy';
                    window.peakChart.options.plugins.zoom.pan.modifierKey = null;
                    console.log('Force enabled pan on chart instance');
                }
                
                // Simple event handlers to test zoom plugin
                canvas.addEventListener('mousedown', function(e) {
                    console.log('Mouse down - zoom plugin should handle pan');
                });
                
                // Add double-click handler for reset zoom
                canvas.addEventListener('dblclick', function() {
                    console.log('Double click detected, resetting zoom');
                    if (window.peakChart.resetZoom) {
                        window.peakChart.resetZoom();
                    } else if (window.peakChart.$zoom && window.peakChart.$zoom.resetZoom) {
                        window.peakChart.$zoom.resetZoom();
                    }
                });

                // Make sure pan is working
                window.peakChart.update('none'); // Update without animation
                
                console.log('Chart setup complete');
            } else {
                console.warn('Chart not initialized yet');
            }
        }

        function generateCSV(data) {
            const rows = [
                ['Method', methodNameStr],
                ['Peaks Detected', peaksData.length],
                ['Data Points', chartData.voltage.length],
                [],
                ['Peak Analysis Results'],
                ['Type', 'Voltage (V)', 'Current (µA)']
            ];

            peaksData.forEach(peak => {
                rows.push([peak.type, peak.x.toFixed(3), peak.y.toFixed(3)]);
            });

            return rows.map(row => row.join(',')).join('\n');
        }
    </script>
</body>
</html>