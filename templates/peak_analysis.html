<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peak Analysis Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .peak-visualization-container {
            width: 100%;
            height: 600px;
            position: relative;
            z-index: 0;  /* Keep canvas behind DevTools */
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #cvPlot {
            width: 100% !important;
            height: 100% !important;
            background: white;
            border-radius: 4px;
            /* Ensure chart fills container */
            display: block;
            box-sizing: border-box;
        }

        .data-info, .peak-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .peak-info {
            margin-bottom: 20px;
        }

        .peak-info .card-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
        }

        .peak-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .peak-item {
            padding: 0.75rem;
            background: white;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .peak-item:last-child {
            border-bottom: none;
        }

        .peak-item:hover {
            background-color: #f8f9fa;
        }

        .peak-item.selected {
            background-color: #e9ecef;
        }

        .peak-type {
            margin-bottom: 0.4rem;
        }

        .type-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
        }

        .type-badge.oxidation {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .type-badge.reduction {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .peak-values {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
        }

        .value-label {
            color: #6c757d;
            font-weight: 500;
        }

        .value {
            color: #212529;
        }

        .peak-confidence {
            font-size: 0.75rem;
        }

        .controls {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .toolbar {
            margin-bottom: 20px;
        }

        .toolbar button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2>Peak Analysis Details</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="peak-visualization-container">
                    <div class="d-flex align-items-center mb-2">
                        <label for="traceSelect" class="me-2 mb-0">Select Trace(s):</label>
                        <select id="traceSelect" class="form-select form-select-sm w-auto" multiple size="4"></select>
                    </div>
                    <div id="plotly-peak-graph" style="width:100%;height:100%;min-height:400px;"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="controls mb-3">
                    <button id="exportPeakDataBtn" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                </div>
                <div class="data-info mb-3">
                    <!-- Data information will be populated here -->
                </div>
                <div class="peak-info card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Peak Information</h6>
                        <span class="badge bg-success">Active Method</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="peak-list">
                            <!-- Peak list will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="peak-details">
                    <!-- Peak details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/peak_analysis_plotly.js"></script>
    <script>
        // Get data from template variables passed from Flask
        const peaksData = {{ peaks|tojson|safe }};
        const chartData = {{ data|tojson|safe }};
        const methodType = {{ method|tojson|safe }};
        const methodNameStr = {{ methodName|tojson|safe }};

        // Helper: detect multi-trace (2D array) or single trace (1D array)
        function isMultiTrace(data) {
            return Array.isArray(data) && Array.isArray(data[0]);
        }

        document.addEventListener('DOMContentLoaded', function() {
            ensurePlotlyReady(function() {
                // Setup trace selector if multi-trace
                let nTraces = 1;
                if (isMultiTrace(chartData.voltage)) {
                    nTraces = chartData.voltage.length;
                }
                const traceSelect = document.getElementById('traceSelect');
                traceSelect.innerHTML = '';
                for (let i = 0; i < nTraces; ++i) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = nTraces > 1 ? `Trace ${i+1}` : 'Trace 1';
                    traceSelect.appendChild(opt);
                }
                // Initial: select only the first trace
                if (traceSelect.options.length > 0) {
                    traceSelect.options[0].selected = true;
                }
                renderMultiTrace([0]);
                updatePeakList(getPeaksForTrace(0));
                updateDataInfo(chartData, getPeaksForTrace(0));
                setupToolbar();
                // On change: support multi-select
                traceSelect.addEventListener('change', function() {
                    const selected = Array.from(this.selectedOptions).map(opt => parseInt(opt.value));
                    renderMultiTrace(selected);
                    // For peak list/info, show only the first selected trace (or none)
                    const firstIdx = selected.length > 0 ? selected[0] : 0;
                    updatePeakList(getPeaksForTrace(firstIdx));
                    updateDataInfo(chartData, getPeaksForTrace(firstIdx));
                });
            });
        });

        // Return peaks for selected trace (if multi-trace, peaksData is array of arrays)
        function getPeaksForTrace(idx) {
            if (Array.isArray(peaksData) && Array.isArray(peaksData[0])) {
                return peaksData[idx] || [];
            }
            return peaksData || [];
        }

        // Render multiple traces and their peaks (all overlays)
        function renderMultiTrace(indices) {
            let voltages = chartData.voltage;
            let currents = chartData.current;
            if (!isMultiTrace(voltages)) {
                voltages = [voltages];
                currents = [currents];
            }
            // Compose traces for Plotly
            const plotTraces = indices.map(idx => ({
                x: voltages[idx],
                y: currents[idx],
                mode: 'lines',
                name: `Trace ${idx+1}`,
                line: { width: 2 },
                hoverinfo: 'x+y',
            }));
            // Compose all peaks for selected traces
            let allPeaks = [];
            indices.forEach(idx => {
                const peaks = getPeaksForTrace(idx);
                if (Array.isArray(peaks)) {
                    allPeaks = allPeaks.concat(peaks.map(p => ({...p, traceIdx: idx})));
                }
            });
            // Add peak marker trace (if any)
            if (allPeaks.length > 0) {
                plotTraces.push({
                    x: allPeaks.map(p => p.x !== undefined ? p.x : p.voltage),
                    y: allPeaks.map(p => p.y !== undefined ? p.y : p.current),
                    mode: 'markers+text',
                    name: 'Peaks',
                    marker: {
                        size: 12,
                        color: allPeaks.map(p => p.type === 'oxidation' ? '#dc3545' : '#198754'),
                        line: { width: 2, color: '#fff' }
                    },
                    text: allPeaks.map(p => (p.type === 'oxidation' ? 'Ox' : 'Red') + ` (T${(p.traceIdx||0)+1})`),
                    textposition: 'top center',
                    hovertemplate: '%{text} peak<br>V: %{x:.3f} V<br>i: %{y:.3f} ÂµA<extra></extra>',
                });
            }
            // Use Plotly directly for flexibility
            const plotDiv = document.getElementById('plotly-peak-graph');
            const layout = {
                title: methodNameStr ? `Peak Analysis: ${methodNameStr}` : 'Peak Analysis',
                xaxis: {
                    title: 'Voltage (V)',
                    tickformat: '.3f',
                    zeroline: false,
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                },
                yaxis: {
                    title: 'Current (ÂµA)',
                    tickformat: '.3f',
                    zeroline: false,
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                },
                margin: { t: 50, l: 60, r: 30, b: 60 },
                legend: { orientation: 'h', y: -0.2 },
                hovermode: 'closest',
                height: 500,
            };
            Plotly.newPlot(plotDiv, plotTraces, layout, {responsive: true});
        }

        function updatePeakList(peaks) {
            const peakList = document.querySelector('.peak-list');
            let peaksArr = [];
            if (Array.isArray(peaks)) {
                peaksArr = peaks;
            } else if (peaks && typeof peaks === 'object') {
                peaksArr = Object.values(peaks);
            }
            peakList.innerHTML = peaksArr.length ? peaksArr.map((peak, index) => `
                <div class="peak-item" data-index="${index}">
                    <div class="peak-type">
                        <span class="type-badge ${peak.type}">${peak.type}</span>
                    </div>
                    <div class="peak-values">
                        <div><span class="value-label">V:</span> <span class="value">${(peak.x !== undefined ? peak.x : peak.voltage).toFixed(3)}</span></div>
                        <div><span class="value-label">i:</span> <span class="value">${(peak.y !== undefined ? peak.y : peak.current).toFixed(3)}</span></div>
                    </div>
                </div>
            `).join('') : '<div class="text-muted p-2">No peaks detected</div>';
        }

        function updateDataInfo(data, peaks) {
            const dataInfo = document.querySelector('.data-info');
            let nPeaks = 0;
            if (Array.isArray(peaks)) nPeaks = peaks.length;
            else if (peaks && typeof peaks === 'object') nPeaks = Object.keys(peaks).length;
            let nPoints = 0;
            if (isMultiTrace(data.voltage)) nPoints = data.voltage[0]?.length || 0;
            else nPoints = data.voltage?.length || 0;
            dataInfo.innerHTML = `
                <h6 class="mb-3">Analysis Summary</h6>
                <div class="mb-2">
                    <strong>Method:</strong> ${methodNameStr}
                </div>
                <div class="mb-2">
                    <strong>Peaks Detected:</strong> ${nPeaks}
                </div>
                <div class="mb-2">
                    <strong>Data Points:</strong> ${nPoints}
                </div>
                <div>
                    <strong>Analysis:</strong> Complete
                </div>
            `;
        }

        function highlightPeak(peak) {
            // (Optional) highlight peak on Plotly graph
        }

        function setupToolbar() {
            // Export Data
            document.getElementById('exportPeakDataBtn').addEventListener('click', function() {
                const csvContent = generateCSV(chartData);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `peak_analysis_${methodType}_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            });
        }

        function generateCSV(data) {
            const rows = [
                ['Method', methodNameStr],
                ['Peaks Detected', peaksData.length],
                ['Data Points', chartData.voltage.length],
                [],
                ['Peak Analysis Results'],
                ['Type', 'Voltage (V)', 'Current (ÂµA)']
            ];

            peaksData.forEach(peak => {
                rows.push([peak.type, peak.x.toFixed(3), peak.y.toFixed(3)]);
            });

            return rows.map(row => row.join(',')).join('\n');
        }
    </script>
</body>
</html>