<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peak Analysis Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .peak-visualization-container {
            width: 100%;
            height: 600px;
            position: relative;
            z-index: 0;  /* Keep canvas behind DevTools */
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #cvPlot {
            width: 100% !important;
            height: 100% !important;
            background: white;
            border-radius: 4px;
            /* Ensure chart fills container */
            display: block;
            box-sizing: border-box;
        }

        .data-info, .peak-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .peak-info {
            margin-bottom: 20px;
        }

        .peak-info .card-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
        }

        .peak-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .peak-item {
            padding: 0.75rem;
            background: white;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .peak-item:last-child {
            border-bottom: none;
        }

        .peak-item:hover {
            background-color: #f8f9fa;
        }

        .peak-item.selected {
            background-color: #e9ecef;
        }

        .peak-item.disabled {
            opacity: 0.5;
            background-color: #f8f9fa;
        }

        .peak-item.disabled .peak-values {
            color: #6c757d;
        }

        .peak-selection {
            flex-shrink: 0;
        }

        .peak-selection .form-check {
            margin-bottom: 0;
        }

        .peak-selection .form-check-input {
            margin-top: 0;
        }

        .peak-values {
            flex: 1;
            min-width: 0;
        }

        .peak-type {
            margin-bottom: 0.4rem;
        }

        .type-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
        }

        .type-badge.oxidation {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .type-badge.reduction {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .peak-values {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
        }

        .value-label {
            color: #6c757d;
            font-weight: 500;
        }

        .value {
            color: #212529;
        }

        .peak-confidence {
            font-size: 0.75rem;
        }

        .controls {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .toolbar {
            margin-bottom: 20px;
        }

        .toolbar button {
            margin-right: 10px;
        }

        .baseline-control-group {
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
            margin-top: 10px;
        }

        .baseline-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .value-label {
            font-weight: 500;
            color: #6c757d;
        }

        .value {
            color: #212529;
            font-family: 'Consolas', monospace;
        }

        .badge.bg-success, .badge.bg-danger {
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2>Peak Analysis Details</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="peak-visualization-container">
                    <div class="d-flex align-items-center mb-2">
                        <label for="traceSelect" class="me-2 mb-0">Select File:</label>
                        <select id="traceSelect" class="form-select form-select-sm w-auto"></select>
                    </div>
                    <div id="plotly-peak-graph" style="width:100%;height:100%;min-height:400px;"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="controls mb-3">
                    <button id="exportPeakDataBtn" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-download"></i> Export Peak Data
                    </button>
                    <button id="exportBaselineBtn" class="btn btn-outline-primary btn-sm w-100 mb-2">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Export Baseline
                    </button>
                    <button id="toggleBaselineBtn" class="btn btn-outline-secondary btn-sm w-100 mb-2">
                        <i class="bi bi-graph-up"></i> Show/Hide Baseline
                    </button>
                    <button id="recalculateBaselineBtn" class="btn btn-outline-info btn-sm w-100 mb-2">
                        <i class="bi bi-arrow-clockwise"></i> Recalculate Baseline
                    </button>
                </div>
                <div class="data-info mb-3">
                    <!-- Data information will be populated here -->
                </div>
                
                <!-- Parameter Logging Section -->
                <div class="parameter-logging card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-save"></i> Parameter Logging
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label for="sampleId" class="form-label form-label-sm">Sample ID</label>
                            <input type="text" class="form-control form-control-sm" id="sampleId" 
                                   placeholder="e.g., Sample_001" required>
                        </div>
                        <div class="mb-2">
                            <label for="instrumentType" class="form-label form-label-sm">Instrument</label>
                            <select class="form-select form-select-sm" id="instrumentType" required>
                                <option value="">Select instrument</option>
                                <option value="palmsens">Palmsens (Reference)</option>
                                <option value="stm32">STM32 (Target)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="userNotes" class="form-label form-label-sm">Notes</label>
                            <textarea class="form-control form-control-sm" id="userNotes" rows="2" 
                                      placeholder="Measurement conditions, observations..."></textarea>
                        </div>
                        <button id="saveParametersBtn" class="btn btn-success btn-sm w-100" disabled>
                            <i class="bi bi-cloud-upload"></i> Save Analysis Parameters
                        </button>
                        <div id="saveStatus" class="mt-2 small"></div>
                    </div>
                </div>
                
                <div class="peak-info card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">Peak Information</h6>
                                <div class="small text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>Ctrl+Click</strong> peak on graph to toggle, or use checkboxes
                                </div>
                            </div>
                            <span class="badge bg-success">Active Method</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="peak-list">
                            <!-- Peak list will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="peak-details">
                    <!-- Peak details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="/static/js/peak_analysis_plotly.js"></script>
    <script>
        // Get data from template variables passed from Flask
        const peaksData = {{ peaks|tojson|safe }};
        const chartData = {{ data|tojson|safe }};
        const methodType = {{ method|tojson|safe }};
        const methodNameStr = {{ methodName|tojson|safe }};
        
        // Store global references for peak management
        window.chartData = chartData;
        window.methodNameStr = methodNameStr;
        window._isArrayObj = false;
        
        // Debug: Check what data we received
        console.log('[DEBUG] peaksData:', peaksData);
        console.log('[DEBUG] chartData:', chartData);
        console.log('[DEBUG] methodType:', methodType);
        console.log('[DEBUG] methodNameStr:', methodNameStr);
        
        // Debug: Check first peak data for baseline info
        if (peaksData && peaksData.length > 0) {
            console.log('[DEBUG] First peaksData item:', peaksData[0]);
            console.log('[DEBUG] Peak data keys:', Object.keys(peaksData[0]));
            
            // Check individual peaks for baseline
            if (peaksData[0].length > 0) {
                console.log('[DEBUG] First peak in first trace:', peaksData[0][0]);
                console.log('[DEBUG] First peak keys:', Object.keys(peaksData[0][0]));
            }
        }

        // Helper: ensure Plotly is ready
        function ensurePlotlyReady(callback) {
            if (typeof Plotly !== 'undefined') {
                callback();
            } else {
                setTimeout(() => ensurePlotlyReady(callback), 100);
            }
        }

        // Helper: detect multi-trace (2D array) or single trace (1D array)
        function isMultiTrace(data) {
            // Support both array of object and object with voltage: [][].
            if (Array.isArray(data)) {
                if (data.length > 0 && typeof data[0] === 'object' && data[0].voltage && Array.isArray(data[0].voltage)) {
                    return true; // array of object
                }
            }
            if (Array.isArray(data) && Array.isArray(data[0])) return true;
            return false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure all scripts are loaded
            setTimeout(function() {
                ensurePlotlyReady(function() {
                    // Check if data exists
                    if (!chartData || (!Array.isArray(chartData) && !chartData.voltage)) {
                        console.error('No chart data available!');
                        const plotDiv = document.getElementById('plotly-peak-graph');
                        if (plotDiv) plotDiv.innerHTML = '<div class="text-danger p-4">No chart data available</div>';
                        return;
                    }
                    
                    console.log('[DEBUG] About to process chart data...');
                    console.log('[DEBUG] chartData.length:', chartData.length);
                    console.log('[DEBUG] First item:', chartData[0]);
                
                let nTraces = 1;
                let fileLabels = [];
                let isArrayObj = false;
                // Detect array of object format
                if (Array.isArray(chartData) && chartData.length > 0 && typeof chartData[0] === 'object' && chartData[0].voltage) {
                    nTraces = chartData.length;
                    isArrayObj = true;
                    fileLabels = chartData.map((d, i) => d.filename || d.label || `Trace ${i+1}`);
                } else if (chartData && chartData.voltage && Array.isArray(chartData.voltage[0])) {
                    nTraces = chartData.voltage.length;
                    isArrayObj = false;
                    if (Array.isArray(chartData.filenames)) {
                        fileLabels = chartData.filenames;
                    } else if (Array.isArray(chartData.file_labels)) {
                        fileLabels = chartData.file_labels;
                    } else {
                        for (let i = 0; i < nTraces; ++i) fileLabels.push(nTraces > 1 ? `Trace ${i+1}` : 'Trace 1');
                    }
                } else {
                    nTraces = 1;
                    isArrayObj = false;
                    fileLabels = ['Trace 1'];
                }
                
                // Save for renderSingleTrace - SET THIS BEFORE CALLING renderSingleTrace
                window._isArrayObj = isArrayObj;
                
                const traceSelect = document.getElementById('traceSelect');
                traceSelect.innerHTML = '';
                for (let i = 0; i < nTraces; ++i) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = fileLabels[i];
                    traceSelect.appendChild(opt);
                }
                
                // Initial: select only the first file and render
                if (traceSelect.options.length > 0) {
                    traceSelect.options[0].selected = true;
                    renderSingleTrace(0);
                    updatePeakList(getPeaksForTrace(0));
                    updateDataInfo(chartData, getPeaksForTrace(0));
                }
                
                setupToolbar();
                setupBaselineControls(); // Setup baseline control buttons
                // On change: single select
                traceSelect.addEventListener('change', function() {
                    const idx = parseInt(this.value);
                    renderSingleTrace(idx);
                    updatePeakList(getPeaksForTrace(idx));
                    updateDataInfo(chartData, getPeaksForTrace(idx));
                });
            });
            }, 200); // End of timeout
        }); // End of DOMContentLoaded

        // Return peaks for selected trace (if multi-trace, peaksData is array of arrays)
        function getPeaksForTrace(idx) {
            if (Array.isArray(peaksData) && Array.isArray(peaksData[0])) {
                return peaksData[idx] || [];
            }
            return peaksData || [];
        }

        // Render only one trace and its peaks
        function renderSingleTrace(idx) {
            let voltage, current, label;
            if (window._isArrayObj) {
                voltage = chartData[idx]?.voltage || [];
                current = chartData[idx]?.current || [];
                label = chartData[idx]?.filename || chartData[idx]?.label || `Trace ${idx+1}`;
            } else if (chartData && chartData.voltage && Array.isArray(chartData.voltage[0])) {
                voltage = chartData.voltage[idx] || [];
                current = chartData.current[idx] || [];
                label = (chartData.filenames && chartData.filenames[idx]) || (chartData.file_labels && chartData.file_labels[idx]) || `Trace ${idx+1}`;
            } else {
                voltage = chartData.voltage || [];
                current = chartData.current || [];
                label = 'Trace 1';
            }
            
            // Defensive: if no data, show message and skip plot
            if (!voltage || !current || voltage.length === 0 || current.length === 0) {
                const plotDiv = document.getElementById('plotly-peak-graph');
                if (plotDiv) plotDiv.innerHTML = '<div class="text-muted p-4">No data for this file.</div>';
                return;
            }
            
            let peaks = getPeaksForTrace(idx);
            if (!Array.isArray(peaks)) peaks = [];
            
            console.log('[DEBUG] About to call renderPeakAnalysisPlot with:');
            console.log('[DEBUG] - voltage.length:', voltage.length);
            console.log('[DEBUG] - current.length:', current.length);
            console.log('[DEBUG] - label:', label);
            console.log('[DEBUG] - peaks.length:', peaks.length);
            console.log('[DEBUG] - methodNameStr:', methodNameStr);
            
            renderPeakAnalysisPlot({voltage, current, label}, peaks, methodNameStr);
        }

        function updatePeakList(peaks) {
            const peakList = document.querySelector('.peak-list');
            let peaksArr = [];
            if (Array.isArray(peaks)) {
                peaksArr = peaks;
            } else if (peaks && typeof peaks === 'object') {
                peaksArr = Object.values(peaks);
            }
            
            // Store global reference for peak management
            window.currentPeaks = peaksArr;
            
            peakList.innerHTML = peaksArr.length ? peaksArr.map((peak, index) => {
                let heightInfo = '';
                if (peak.height !== undefined) {
                    heightInfo = `<div><span class="value-label">Height:</span> <span class="value">${peak.height.toFixed(3)} µA</span></div>`;
                }
                
                // Set initial enabled state (default: true)
                if (peak.enabled === undefined) {
                    peak.enabled = true;
                }
                
                return `
                <div class="peak-item ${peak.enabled ? '' : 'disabled'}" data-index="${index}">
                    <div class="peak-selection">
                        <div class="form-check">
                            <input class="form-check-input peak-checkbox" type="checkbox" 
                                   id="peak-${index}" ${peak.enabled ? 'checked' : ''} 
                                   data-peak-index="${index}">
                            <label class="form-check-label" for="peak-${index}">
                                <span class="type-badge ${peak.type}">${peak.type}</span>
                            </label>
                        </div>
                    </div>
                    <div class="peak-values">
                        <div><span class="value-label">V:</span> <span class="value">${(peak.x !== undefined ? peak.x : peak.voltage).toFixed(3)}</span></div>
                        <div><span class="value-label">i:</span> <span class="value">${(peak.y !== undefined ? peak.y : peak.current).toFixed(3)}</span></div>
                        ${heightInfo}
                    </div>
                </div>
            `}).join('') : '<div class="text-muted p-2">No peaks detected</div>';
            
            // Add event listeners for peak checkboxes
            const checkboxes = peakList.querySelectorAll('.peak-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', handlePeakToggle);
            });
        }

        function handlePeakToggle(event) {
            const checkbox = event.target;
            const peakIndex = parseInt(checkbox.dataset.peakIndex);
            const isEnabled = checkbox.checked;
            
            // Update peak enabled state
            if (window.currentPeaks && window.currentPeaks[peakIndex]) {
                window.currentPeaks[peakIndex].enabled = isEnabled;
            }
            
            // Update visual state of peak item
            const peakItem = checkbox.closest('.peak-item');
            if (isEnabled) {
                peakItem.classList.remove('disabled');
            } else {
                peakItem.classList.add('disabled');
            }
            
            // Re-render the plot with updated peak states
            if (window.chartData && window.currentPeaks) {
                const data = window.chartData;
                const peaks = window.currentPeaks;
                const methodNameStr = window.methodNameStr;
                
                // Prepare data for plotting
                let voltage, current, label;
                if (window._isArrayObj && Array.isArray(data)) {
                    const traceSelect = document.getElementById('traceSelect');
                    const currentIdx = parseInt(traceSelect.value) || 0;
                    const currentData = data[currentIdx];
                    voltage = currentData.voltage;
                    current = currentData.current;
                    label = currentData.label || `Trace ${currentIdx + 1}`;
                } else {
                    voltage = data.voltage;
                    current = data.current;
                    label = data.label;
                }
                
                // Re-render plot
                renderPeakAnalysisPlot({voltage, current, label}, peaks, methodNameStr);
            }
            
            console.log(`[PEAK TOGGLE] Peak ${peakIndex} (${window.currentPeaks[peakIndex].type}) ${isEnabled ? 'enabled' : 'disabled'}`);
        }

        function updateDataInfo(data, peaks) {
            const dataInfo = document.querySelector('.data-info');
            let nPeaks = 0;
            if (Array.isArray(peaks)) nPeaks = peaks.length;
            else if (peaks && typeof peaks === 'object') nPeaks = Object.keys(peaks).length;
            
            let nPoints = 0;
            // Get current selected trace index
            const traceSelect = document.getElementById('traceSelect');
            const currentIdx = parseInt(traceSelect.value) || 0;
            
            if (window._isArrayObj && Array.isArray(data) && data[currentIdx]) {
                // Array of objects format
                nPoints = data[currentIdx].voltage?.length || 0;
            } else if (data && data.voltage && Array.isArray(data.voltage[0])) {
                // Multi-trace format
                nPoints = data.voltage[currentIdx]?.length || 0;
            } else if (data && data.voltage) {
                // Single trace format
                nPoints = data.voltage.length || 0;
            }
            
            // Calculate peak heights with baseline
            let peaksWithHeight = 0;
            if (Array.isArray(peaks)) {
                peaksWithHeight = peaks.filter(p => p.height !== undefined).length;
            }
            
            // Baseline info
            let baselineStatus = 'Not calculated';
            if (window.currentBaselineInfo) {
                baselineStatus = 'Available';
            }
            
            dataInfo.innerHTML = `
                <h6 class="mb-3">Analysis Summary</h6>
                <div class="mb-2">
                    <strong>Method:</strong> ${methodNameStr}
                </div>
                <div class="mb-2">
                    <strong>Peaks Detected:</strong> ${nPeaks}
                </div>
                <div class="mb-2">
                    <strong>Peak Heights:</strong> ${peaksWithHeight}/${nPeaks}
                </div>
                <div class="mb-2">
                    <strong>Baseline Status:</strong> <span class="badge ${baselineStatus === 'Available' ? 'bg-success' : 'bg-secondary'}">${baselineStatus}</span>
                </div>
                <div class="mb-2">
                    <strong>Data Points:</strong> ${nPoints}
                </div>
                <div>
                    <strong>Analysis:</strong> Complete
                </div>
            `;
        }

        function highlightPeak(peak) {
            // (Optional) highlight peak on Plotly graph
        }

        function setupToolbar() {
            // Export Data
            document.getElementById('exportPeakDataBtn').addEventListener('click', function() {
                const csvContent = generateCSV(chartData);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `peak_analysis_${methodType}_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            });
        }

        function generateCSV(data) {
            const rows = [
                ['Method', methodNameStr],
                ['Peaks Detected', peaksData.length],
                ['Data Points', chartData.voltage.length],
                [],
                ['Peak Analysis Results'],
                ['Type', 'Voltage (V)', 'Current (µA)']
            ];

            peaksData.forEach(peak => {
                rows.push([peak.type, peak.x.toFixed(3), peak.y.toFixed(3)]);
            });

            return rows.map(row => row.join(',')).join('\n');
        }

        // Parameter Logging Functions
        function initializeParameterLogging() {
            const sampleIdInput = document.getElementById('sampleId');
            const instrumentSelect = document.getElementById('instrumentType');
            const saveBtn = document.getElementById('saveParametersBtn');
            
            // Enable save button when required fields are filled
            function checkFormValidity() {
                const isValid = sampleIdInput.value.trim() && instrumentSelect.value;
                saveBtn.disabled = !isValid;
            }
            
            sampleIdInput.addEventListener('input', checkFormValidity);
            instrumentSelect.addEventListener('change', checkFormValidity);
            
            // Save parameters event
            saveBtn.addEventListener('click', saveAnalysisParameters);
            
            // Try to detect file source for auto-suggestion
            autoDetectInstrument();
        }
        
        function autoDetectInstrument() {
            // Auto-detect instrument type based on file name or data characteristics
            const filenameElement = document.querySelector('[data-filename]');
            const instrumentSelect = document.getElementById('instrumentType');
            
            if (filenameElement) {
                const filename = filenameElement.dataset.filename.toLowerCase();
                if (filename.includes('palmsens') || filename.includes('ps')) {
                    instrumentSelect.value = 'palmsens';
                } else if (filename.includes('stm32') || filename.includes('h743')) {
                    instrumentSelect.value = 'stm32';
                }
            }
            
            // Check form validity after auto-detection
            const saveBtn = document.getElementById('saveParametersBtn');
            const sampleIdInput = document.getElementById('sampleId');
            const isValid = sampleIdInput.value.trim() && instrumentSelect.value;
            saveBtn.disabled = !isValid;
        }
        
        async function saveAnalysisParameters() {
            try {
                const saveBtn = document.getElementById('saveParametersBtn');
                const statusDiv = document.getElementById('saveStatus');
                
                // Disable button and show loading
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
                statusDiv.innerHTML = '<div class="text-info">Preparing data...</div>';
                
                // Collect form data
                const sampleId = document.getElementById('sampleId').value.trim();
                const instrumentType = document.getElementById('instrumentType').value;
                const userNotes = document.getElementById('userNotes').value.trim();
                
                // Prepare measurement data
                const measurementData = {
                    sample_id: sampleId,
                    instrument_type: instrumentType,
                    user_notes: userNotes,
                    original_filename: getCurrentFilename(),
                    data_points: chartData.voltage ? chartData.voltage.length : 0
                };
                
                // Add method parameters if available
                if (methodNameStr) {
                    measurementData.method_name = methodNameStr;
                }
                
                // Detect scan parameters from data
                if (chartData.voltage && chartData.voltage.length > 1) {
                    measurementData.voltage_start = Math.min(...chartData.voltage);
                    measurementData.voltage_end = Math.max(...chartData.voltage);
                    
                    // Estimate scan rate (rough calculation)
                    const voltageRange = measurementData.voltage_end - measurementData.voltage_start;
                    const estimatedScanRate = Math.round(voltageRange * 1000 / chartData.voltage.length); // Rough estimate
                    measurementData.scan_rate = estimatedScanRate;
                }
                
                // Prepare peak data with baseline info
                const enabledPeaks = window.currentPeaks ? 
                    window.currentPeaks.filter(p => p.enabled !== false) : 
                    peaksData.filter(p => p.enabled !== false);
                
                const peakParameters = enabledPeaks.map((peak, index) => ({
                    type: peak.type,
                    voltage: peak.x || peak.voltage,
                    current: peak.y || peak.current,
                    height: peak.height,
                    enabled: peak.enabled !== false,
                    baseline_current: peak.baseline_current,
                    peak_index: index,
                    // Add any additional peak characteristics
                    area: peak.area,
                    prominence: peak.prominence,
                    width_half_max: peak.width_half_max
                }));
                
                // Prepare request payload
                const payload = {
                    measurement: measurementData,
                    peaks: peakParameters
                };
                
                // Add raw data for STM32
                if (instrumentType === 'stm32') {
                    payload.raw_data = {
                        voltage: chartData.voltage,
                        current: chartData.current,
                        label: chartData.label
                    };
                }
                
                statusDiv.innerHTML = '<div class="text-info">Uploading to database...</div>';
                
                // Send to API
                const response = await fetch('/api/parameters/save_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="text-success">
                            <i class="bi bi-check-circle"></i> 
                            Saved successfully! ID: ${result.measurement_id}
                            <br><small>${result.peaks_saved} peaks saved</small>
                        </div>
                    `;
                    
                    // Reset form after successful save
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                        document.getElementById('userNotes').value = '';
                    }, 3000);
                    
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Error saving parameters:', error);
                const statusDiv = document.getElementById('saveStatus');
                statusDiv.innerHTML = `
                    <div class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Error: ${error.message}
                    </div>
                `;
            } finally {
                // Re-enable button
                const saveBtn = document.getElementById('saveParametersBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Save Analysis Parameters';
            }
        }
        
        function getCurrentFilename() {
            // Try to get current filename from various sources
            const filenameElement = document.querySelector('[data-filename]');
            if (filenameElement) {
                return filenameElement.dataset.filename;
            }
            
            // Try from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('file') || urlParams.get('filename');
            if (filename) {
                return filename;
            }
            
            // Default fallback
            return `analysis_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
        }
        
        // Initialize parameter logging when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeParameterLogging();
        });
    </script>
    {% block scripts %}
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="{{ url_for('static', filename='js/cv_measurement.js') }}"></script>
    {% endblock %}
</body>
</html>