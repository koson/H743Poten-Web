<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peak Analysis Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .peak-visualization-container {
            width: 100%;
            height: 600px;
            position: relative;
            z-index: 0;  /* Keep canvas behind DevTools */
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #cvPlot {
            width: 100% !important;
            height: 100% !important;
            background: white;
            border-radius: 4px;
            /* Ensure chart fills container */
            display: block;
            box-sizing: border-box;
        }

        .data-info, .peak-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .peak-info {
            margin-bottom: 20px;
        }

        .peak-info .card-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
        }

        .peak-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .peak-item {
            padding: 0.75rem;
            background: white;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .peak-item:last-child {
            border-bottom: none;
        }

        .peak-item:hover {
            background-color: #f8f9fa;
        }

        .peak-item.selected {
            background-color: #e9ecef;
        }

        .peak-type {
            margin-bottom: 0.4rem;
        }

        .type-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
        }

        .type-badge.oxidation {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .type-badge.reduction {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .peak-values {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
        }

        .value-label {
            color: #6c757d;
            font-weight: 500;
        }

        .value {
            color: #212529;
        }

        .peak-confidence {
            font-size: 0.75rem;
        }

        .controls {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .toolbar {
            margin-bottom: 20px;
        }

        .toolbar button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2>Peak Analysis Details</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div class="peak-visualization-container">
                    <div class="d-flex align-items-center mb-2">
                        <label for="traceSelect" class="me-2 mb-0">Select File:</label>
                        <select id="traceSelect" class="form-select form-select-sm w-auto"></select>
                    </div>
                    <div id="plotly-peak-graph" style="width:100%;height:100%;min-height:400px;"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="controls mb-3">
                    <button id="exportPeakDataBtn" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="bi bi-download"></i> Export Data
                    </button>
                </div>
                <div class="data-info mb-3">
                    <!-- Data information will be populated here -->
                </div>
                <div class="peak-info card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Peak Information</h6>
                        <span class="badge bg-success">Active Method</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="peak-list">
                            <!-- Peak list will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="peak-details">
                    <!-- Peak details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="/static/js/peak_analysis_plotly.js"></script>
    <script>
        // Get data from template variables passed from Flask
        const peaksData = {{ peaks|tojson|safe }};
        const chartData = {{ data|tojson|safe }};
        const methodType = {{ method|tojson|safe }};
        const methodNameStr = {{ methodName|tojson|safe }};

        // Helper: ensure Plotly is ready
        function ensurePlotlyReady(callback) {
            if (typeof Plotly !== 'undefined') {
                callback();
            } else {
                setTimeout(() => ensurePlotlyReady(callback), 100);
            }
        }

        // Helper: detect multi-trace (2D array) or single trace (1D array)
        function isMultiTrace(data) {
            // Support both array of object and object with voltage: [][].
            if (Array.isArray(data)) {
                if (data.length > 0 && typeof data[0] === 'object' && data[0].voltage && Array.isArray(data[0].voltage)) {
                    return true; // array of object
                }
            }
            if (Array.isArray(data) && Array.isArray(data[0])) return true;
            return false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure all scripts are loaded
            setTimeout(function() {
                ensurePlotlyReady(function() {
                    // Check if data exists
                    if (!chartData || (!Array.isArray(chartData) && !chartData.voltage)) {
                        console.error('No chart data available!');
                        const plotDiv = document.getElementById('plotly-peak-graph');
                        if (plotDiv) plotDiv.innerHTML = '<div class="text-danger p-4">No chart data available</div>';
                        return;
                    }
                
                let nTraces = 1;
                let fileLabels = [];
                let isArrayObj = false;
                // Detect array of object format
                if (Array.isArray(chartData) && chartData.length > 0 && typeof chartData[0] === 'object' && chartData[0].voltage) {
                    nTraces = chartData.length;
                    isArrayObj = true;
                    fileLabels = chartData.map((d, i) => d.filename || d.label || `Trace ${i+1}`);
                } else if (chartData && chartData.voltage && Array.isArray(chartData.voltage[0])) {
                    nTraces = chartData.voltage.length;
                    isArrayObj = false;
                    if (Array.isArray(chartData.filenames)) {
                        fileLabels = chartData.filenames;
                    } else if (Array.isArray(chartData.file_labels)) {
                        fileLabels = chartData.file_labels;
                    } else {
                        for (let i = 0; i < nTraces; ++i) fileLabels.push(nTraces > 1 ? `Trace ${i+1}` : 'Trace 1');
                    }
                } else {
                    nTraces = 1;
                    isArrayObj = false;
                    fileLabels = ['Trace 1'];
                }
                
                // Save for renderSingleTrace - SET THIS BEFORE CALLING renderSingleTrace
                window._isArrayObj = isArrayObj;
                
                const traceSelect = document.getElementById('traceSelect');
                traceSelect.innerHTML = '';
                for (let i = 0; i < nTraces; ++i) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = fileLabels[i];
                    traceSelect.appendChild(opt);
                }
                
                // Initial: select only the first file and render
                if (traceSelect.options.length > 0) {
                    traceSelect.options[0].selected = true;
                    renderSingleTrace(0);
                    updatePeakList(getPeaksForTrace(0));
                    updateDataInfo(chartData, getPeaksForTrace(0));
                }
                
                setupToolbar();
                // On change: single select
                traceSelect.addEventListener('change', function() {
                    const idx = parseInt(this.value);
                    renderSingleTrace(idx);
                    updatePeakList(getPeaksForTrace(idx));
                    updateDataInfo(chartData, getPeaksForTrace(idx));
                });
            });
            }, 200); // End of timeout
        }); // End of DOMContentLoaded

        // Return peaks for selected trace (if multi-trace, peaksData is array of arrays)
        function getPeaksForTrace(idx) {
            if (Array.isArray(peaksData) && Array.isArray(peaksData[0])) {
                return peaksData[idx] || [];
            }
            return peaksData || [];
        }

        // Render only one trace and its peaks
        function renderSingleTrace(idx) {
            let voltage, current, label;
            if (window._isArrayObj) {
                voltage = chartData[idx]?.voltage || [];
                current = chartData[idx]?.current || [];
                label = chartData[idx]?.filename || chartData[idx]?.label || `Trace ${idx+1}`;
            } else if (chartData && chartData.voltage && Array.isArray(chartData.voltage[0])) {
                voltage = chartData.voltage[idx] || [];
                current = chartData.current[idx] || [];
                label = (chartData.filenames && chartData.filenames[idx]) || (chartData.file_labels && chartData.file_labels[idx]) || `Trace ${idx+1}`;
            } else {
                voltage = chartData.voltage || [];
                current = chartData.current || [];
                label = 'Trace 1';
            }
            
            // Defensive: if no data, show message and skip plot
            if (!voltage || !current || voltage.length === 0 || current.length === 0) {
                const plotDiv = document.getElementById('plotly-peak-graph');
                if (plotDiv) plotDiv.innerHTML = '<div class="text-muted p-4">No data for this file.</div>';
                return;
            }
            
            let peaks = getPeaksForTrace(idx);
            if (!Array.isArray(peaks)) peaks = [];
            renderPeakAnalysisPlot({voltage, current, label}, peaks, methodNameStr);
        }

        function updatePeakList(peaks) {
            const peakList = document.querySelector('.peak-list');
            let peaksArr = [];
            if (Array.isArray(peaks)) {
                peaksArr = peaks;
            } else if (peaks && typeof peaks === 'object') {
                peaksArr = Object.values(peaks);
            }
            peakList.innerHTML = peaksArr.length ? peaksArr.map((peak, index) => `
                <div class="peak-item" data-index="${index}">
                    <div class="peak-type">
                        <span class="type-badge ${peak.type}">${peak.type}</span>
                    </div>
                    <div class="peak-values">
                        <div><span class="value-label">V:</span> <span class="value">${(peak.x !== undefined ? peak.x : peak.voltage).toFixed(3)}</span></div>
                        <div><span class="value-label">i:</span> <span class="value">${(peak.y !== undefined ? peak.y : peak.current).toFixed(3)}</span></div>
                    </div>
                </div>
            `).join('') : '<div class="text-muted p-2">No peaks detected</div>';
        }

        function updateDataInfo(data, peaks) {
            const dataInfo = document.querySelector('.data-info');
            let nPeaks = 0;
            if (Array.isArray(peaks)) nPeaks = peaks.length;
            else if (peaks && typeof peaks === 'object') nPeaks = Object.keys(peaks).length;
            
            let nPoints = 0;
            // Get current selected trace index
            const traceSelect = document.getElementById('traceSelect');
            const currentIdx = parseInt(traceSelect.value) || 0;
            
            if (window._isArrayObj && Array.isArray(data) && data[currentIdx]) {
                // Array of objects format
                nPoints = data[currentIdx].voltage?.length || 0;
            } else if (data && data.voltage && Array.isArray(data.voltage[0])) {
                // Multi-trace format
                nPoints = data.voltage[currentIdx]?.length || 0;
            } else if (data && data.voltage) {
                // Single trace format
                nPoints = data.voltage.length || 0;
            }
            dataInfo.innerHTML = `
                <h6 class="mb-3">Analysis Summary</h6>
                <div class="mb-2">
                    <strong>Method:</strong> ${methodNameStr}
                </div>
                <div class="mb-2">
                    <strong>Peaks Detected:</strong> ${nPeaks}
                </div>
                <div class="mb-2">
                    <strong>Data Points:</strong> ${nPoints}
                </div>
                <div>
                    <strong>Analysis:</strong> Complete
                </div>
            `;
        }

        function highlightPeak(peak) {
            // (Optional) highlight peak on Plotly graph
        }

        function setupToolbar() {
            // Export Data
            document.getElementById('exportPeakDataBtn').addEventListener('click', function() {
                const csvContent = generateCSV(chartData);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `peak_analysis_${methodType}_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            });
        }

        function generateCSV(data) {
            const rows = [
                ['Method', methodNameStr],
                ['Peaks Detected', peaksData.length],
                ['Data Points', chartData.voltage.length],
                [],
                ['Peak Analysis Results'],
                ['Type', 'Voltage (V)', 'Current (µA)']
            ];

            peaksData.forEach(peak => {
                rows.push([peak.type, peak.x.toFixed(3), peak.y.toFixed(3)]);
            });

            return rows.map(row => row.join(',')).join('\n');
        }
    </script>
    {% block scripts %}
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="{{ url_for('static', filename='js/cv_measurement.js') }}"></script>
    {% endblock %}
</body>
</html>